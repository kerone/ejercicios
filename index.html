<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academia Pokemon - Aprendizaje Divertido</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            font-size: 16px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üéÆ</text></svg>') no-repeat center;
            background-size: 200px;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        .login-card h1 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 2.5em;
        }

        .login-card input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 18px;
            font-family: inherit;
        }

        .login-card button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.2s;
        }

        .login-card button:hover {
            transform: scale(1.05);
        }

        .main-app {
            display: none;
        }

        .header {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: white;
        }

        .stats {
            display: flex;
            gap: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            min-width: 80px;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 15px 25px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.3s;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .nav-tab:hover, .nav-tab.active {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .content-area {
            background: rgba(255,255,255,0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            min-height: 500px;
        }

        /* Estilos del Ranking */
        .ranking-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .ranking-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }

        .filter-btn {
            padding: 10px 20px;
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
            font-size: 14px;
        }

        .filter-btn:hover, .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .ranking-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .ranking-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            display: grid;
            grid-template-columns: 60px 1fr 100px 100px 100px 120px;
            gap: 15px;
            font-weight: bold;
            align-items: center;
        }

        .ranking-row {
            padding: 15px 20px;
            display: grid;
            grid-template-columns: 60px 1fr 100px 100px 100px 120px;
            gap: 15px;
            align-items: center;
            border-bottom: 1px solid #eee;
            transition: all 0.3s;
        }

        .ranking-row:hover {
            background: #f8f9fa;
        }

        .ranking-row.current-user {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 2px solid #ffc107;
        }

        .position {
            text-align: center;
            font-weight: bold;
            font-size: 18px;
        }

        .position.first {
            color: #ffd700;
            font-size: 24px;
        }

        .position.second {
            color: #c0c0c0;
            font-size: 22px;
        }

        .position.third {
            color: #cd7f32;
            font-size: 20px;
        }

        .user-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .stat-value {
            text-align: center;
            font-weight: bold;
            color: #667eea;
        }

        .achievements-preview {
            display: flex;
            gap: 2px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .achievement-mini {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffd700;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            title: attr(data-title);
        }

        .podium {
            display: flex;
            justify-content: center;
            align-items: end;
            gap: 20px;
            margin: 30px 0;
            height: 200px;
        }

        .podium-place {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            min-width: 150px;
        }

        .podium-place:hover {
            transform: translateY(-5px);
        }

        .podium-place.first {
            height: 180px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            order: 2;
        }

        .podium-place.second {
            height: 150px;
            background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
            order: 1;
        }

        .podium-place.third {
            height: 120px;
            background: linear-gradient(135deg, #cd7f32, #daa520);
            order: 3;
        }

        .podium-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            margin: 0 auto 10px;
        }

        .podium-crown {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 18px;
            color: #667eea;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 16px;
        }

        .week-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .week-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: transform 0.3s;
        }

        .week-card:hover {
            transform: translateY(-5px);
        }

        .day-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .day-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }

        .day-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .exercise-list {
            margin-top: 15px;
        }

        .exercise-item {
            background: #f8f9fa;
            padding: 8px;
            margin: 6px 0;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .exercise-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 1000px;
            width: 95%;
            max-height: 95%;
            overflow-y: auto;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: #999;
        }

        .exercise-content {
            text-align: center;
        }

        .learning-hint {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            font-size: 16px;
            text-align: left;
        }

        .learning-hint strong {
            color: #1976d2;
        }

        .question {
            font-size: 22px;
            margin-bottom: 20px;
            line-height: 1.6;
            text-align: left;
            background: #fff8e1;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #ffc107;
        }

        .reading-text {
            background: #f3e5f5;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 18px;
            line-height: 1.8;
            text-align: left;
            border: 2px solid #9c27b0;
        }

        .reading-text h4 {
            color: #7b1fa2;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .option {
            padding: 15px;
            border: 3px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            font-size: 16px;
            text-align: center;
        }

        .option:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: scale(1.02);
        }

        .option.correct {
            background: #d4edda;
            border-color: #28a745;
            animation: correctPulse 0.6s ease-out;
        }

        .option.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
            animation: incorrectShake 0.6s ease-out;
        }

        /* Estilos para ejercicios interactivos */
        .interactive-exercise {
            margin: 20px 0;
        }

        .drag-drop-area {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .draggable {
            padding: 10px 15px;
            background: #667eea;
            color: white;
            border-radius: 8px;
            cursor: move;
            user-select: none;
            transition: all 0.3s;
        }

        .draggable:hover {
            background: #5a6fdb;
            transform: scale(1.05);
        }

        .draggable.dragging {
            opacity: 0.5;
        }

        .drop-zone {
            min-height: 50px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 10px;
            margin: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .drop-zone.drag-over {
            border-color: #667eea;
            background: #e3f2fd;
        }

        .drop-zone.filled {
            background: #d4edda;
            border-color: #28a745;
        }

        .sequence-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 20px 0;
        }

        .sequence-item {
            width: 60px;
            height: 60px;
            border: 2px solid #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sequence-item:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .sequence-item.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .feedback {
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            display: none;
            font-size: 16px;
            line-height: 1.5;
        }

        .feedback.correct {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .next-btn {
            background: #667eea;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            margin-top: 20px;
            display: none;
            font-family: inherit;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e9ecef;
            border-radius: 6px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.5s ease;
        }

        .reward-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            z-index: 1001;
            animation: popup 0.5s ease-out;
        }

        @keyframes popup {
            from { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            to { transform: translate(-50%, -50()) scale(1); opacity: 1; }
        }

        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .achievement-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border: 2px solid #ddd;
        }

        .achievement-card.unlocked {
            border-color: #ffd700;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
        }

        .achievement-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
        }

        .connection-status.online {
            background: #d4edda;
            color: #155724;
        }

        .connection-status.offline {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }

            .stats {
                width: 100%;
                justify-content: center;
            }

            .nav-tabs {
                justify-content: center;
            }

            .modal-content {
                padding: 20px;
                margin: 10px;
                width: 98%;
            }

            .question {
                font-size: 18px;
            }

            .options {
                grid-template-columns: 1fr;
            }

            .day-grid {
                grid-template-columns: 1fr;
            }

            .draggable {
                font-size: 14px;
                padding: 8px 12px;
            }

            .sequence-container {
                gap: 5px;
            }

            .sequence-item {
                width: 50px;
                height: 50px;
                font-size: 16px;
            }

            .ranking-header,
            .ranking-row {
                grid-template-columns: 40px 1fr 80px 80px 80px;
                gap: 10px;
                font-size: 14px;
            }

            .ranking-header span:nth-child(6),
            .ranking-row .achievements-preview {
                display: none;
            }

            .podium {
                flex-direction: column;
                height: auto;
                gap: 15px;
            }

            .podium-place {
                width: 100%;
                max-width: 300px;
                margin: 0 auto;
                height: auto !important;
            }
        }
    </style>
</head>
<body>
    <!-- Indicador de conexi√≥n -->
    <div id="connectionStatus" class="connection-status offline">üîÑ Conectando...</div>

    <!-- Pantalla de Login -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <h1>üéÆ Academia Pokemon</h1>
            <p style="margin-bottom: 20px; color: #666;">¬°Convi√©rtete en el mejor entrenador de conocimientos!</p>
            <input type="text" id="usernameInput" placeholder="Escribe tu nombre de entrenador" maxlength="20">
            <button onclick="login()">¬°Comenzar Aventura! üöÄ</button>
        </div>
    </div>

    <!-- Aplicaci√≥n Principal -->
    <div id="mainApp" class="main-app">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <div class="user-info">
                    <div class="avatar">üèÜ</div>
                    <div>
                        <h2 id="userName">Entrenador</h2>
                        <p>Nivel <span id="userLevel">1</span></p>
                    </div>
                </div>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalPoints">0</div>
                        <div>Puntos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="streak">0</div>
                        <div>Racha</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="accuracy">0%</div>
                        <div>Precisi√≥n</div>
                    </div>
                </div>
                <button onclick="logout()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Salir</button>
            </div>

            <!-- Navegaci√≥n -->
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('training')">üéØ Entrenamiento</button>
                <button class="nav-tab" onclick="showTab('ranking')">üèÜ Ranking</button>
                <button class="nav-tab" onclick="showTab('achievements')">üéñÔ∏è Logros</button>
                <button class="nav-tab" onclick="showTab('stats')">üìä Estad√≠sticas</button>
                <button class="nav-tab" onclick="showTab('admin')">‚öôÔ∏è Administrar</button>
            </div>

            <!-- √Årea de contenido -->
            <div class="content-area">
                <!-- Pesta√±a de Entrenamiento -->
                <div id="trainingTab" class="tab-content">
                    <h2>üóìÔ∏è Plan de Entrenamiento Semanal</h2>
                    <div class="week-grid" id="weekGrid"></div>
                    <div id="dayView" style="display: none;">
                        <button onclick="backToWeeks()" style="margin-bottom: 20px; padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">‚Üê Volver a Semanas</button>
                        <h3 id="dayTitle"></h3>
                        <div class="day-grid" id="dayGrid"></div>
                    </div>
                </div>

                <!-- Pesta√±a de Ranking -->
                <div id="rankingTab" class="tab-content" style="display: none;">
                    <h2>üèÜ Ranking de Entrenadores</h2>
                    <div class="ranking-container">
                        <!-- Filtros -->
                        <div class="ranking-filters">
                            <button class="filter-btn active" onclick="setRankingFilter('achievements')">üéñÔ∏è Logros</button>
                            <button class="filter-btn" onclick="setRankingFilter('points')">üí∞ Puntos</button>
                            <button class="filter-btn" onclick="setRankingFilter('level')">üìà Nivel</button>
                            <button class="filter-btn" onclick="setRankingFilter('exercises')">üìö Ejercicios</button>
                            <button class="filter-btn" onclick="setRankingFilter('accuracy')">üéØ Precisi√≥n</button>
                            <button class="filter-btn" onclick="setRankingFilter('streak')">üî• Racha</button>
                        </div>

                        <!-- Podio para top 3 -->
                        <div id="podiumContainer" class="podium"></div>

                        <!-- Tabla de ranking -->
                        <div id="rankingTableContainer"></div>
                    </div>
                </div>

                <!-- Pesta√±a de Logros -->
                <div id="achievementsTab" class="tab-content" style="display: none;">
                    <h2>üèÜ Tus Logros de Entrenador</h2>
                    <div class="achievement-grid" id="achievementGrid"></div>
                </div>

                <!-- Pesta√±a de Estad√≠sticas -->
                <div id="statsTab" class="tab-content" style="display: none;">
                    <h2>üìä Estad√≠sticas Detalladas</h2>
                    <div id="statsContent"></div>
                </div>

                <!-- Pesta√±a de Administraci√≥n -->
                <div id="adminTab" class="tab-content" style="display: none;">
                    <h2>‚öôÔ∏è Panel de Administraci√≥n</h2>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4>üìä Estado de Guardado</h4>
                        <p>Los datos se guardan autom√°ticamente en JSONBin.io</p>
                        <p><strong>Usuario actual:</strong> <span id="currentUserAdmin"></span></p>
                        <p><strong>√öltima sincronizaci√≥n:</strong> <span id="lastSync">-</span></p>
                    </div>
                    <button onclick="testConnection()" style="padding: 15px 30px; background: #17a2b8; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; margin: 10px;">üîÑ Probar Conexi√≥n</button>
                    <button onclick="resetProgress()" style="padding: 15px 30px; background: #dc3545; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; margin: 10px;">üîÑ Reiniciar Progreso</button>
                    <button onclick="exportData()" style="padding: 15px 30px; background: #28a745; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; margin: 10px;">üì• Exportar Datos</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Ejercicio -->
    <div id="exerciseModal" class="exercise-modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeExercise()">√ó</button>
            <div class="exercise-content">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <h3 id="exerciseTitle"></h3>
                <div id="learningHint" class="learning-hint" style="display: none;"></div>
                <div id="readingText" class="reading-text" style="display: none;"></div>
                <div id="exerciseQuestion" class="question"></div>
                <div id="interactiveArea" class="interactive-exercise" style="display: none;"></div>
                <div id="exerciseOptions" class="options"></div>
                <div id="exerciseFeedback" class="feedback"></div>
                <button id="nextExerciseBtn" class="next-btn" onclick="nextExercise()">Siguiente</button>
            </div>
        </div>
    </div>

    <!-- Popup de Recompensa -->
    <div id="rewardPopup" class="reward-popup">
        <h2 id="rewardTitle"></h2>
        <div id="rewardIcon" style="font-size: 60px; margin: 20px 0;"></div>
        <p id="rewardMessage"></p>
        <button onclick="closeReward()" style="margin-top: 20px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">¬°Genial!</button>
    </div>

    <script>
        // Configuraci√≥n de JSONBin
        const JSONBIN_CONFIG = {
            binId: '68ee144343b1c97be96704f9',
            masterKey: '$2a$10$byEkgCiPtr6uA9j.sw5Uiuld00jGPRMT1Rn9TlhHYbPe3CFfaEu6G',
            apiUrl: 'https://api.jsonbin.io/v3'
        };

        // Estado global de la aplicaci√≥n
        let appState = {
            currentUser: null,
            userData: {},
            currentExerciseSet: [],
            currentExerciseIndex: 0,
            currentSessionStats: { correct: 0, total: 0 },
            connectionStatus: 'offline',
            allUsersData: {},
            currentRankingFilter: 'achievements'
        };

        // Base de datos de ejercicios (mantengo solo una peque√±a parte por espacio)
        const exerciseDatabase = {
            week1: {
                day1: [
                    {
                        type: 'math',
                        theme: 'pokemon',
                        learningHint: '<strong>üí° Suma con llevadas:</strong> Cuando la suma de unidades es mayor que 9, "llevamos" a las decenas.',
                        question: 'üî• Charizard ten√≠a 47 puntos de ataque. Despu√©s de entrenar intensamente con Ash, gan√≥ 28 puntos m√°s. ¬øCu√°ntos puntos de ataque tiene ahora?',
                        options: ['75 puntos', '65 puntos', '71 puntos', '79 puntos'],
                        correct: 0,
                        explanation: '¬°Perfecto! 47 + 28 = 75. Recuerda: 7 + 8 = 15, escribimos 5 y llevamos 1. Luego 4 + 2 + 1 = 7.'
                    },
                    {
                        type: 'reading',
                        theme: 'pokemon',
                        learningHint: '<strong>üìö Comprensi√≥n lectora:</strong> Lee despacio y busca detalles espec√≠ficos.',
                        readingText: '<h4>üîµ El Entrenamiento de Pikachu</h4>Pikachu es un Pok√©mon el√©ctrico muy especial que vive en los densos bosques verdes cerca de Pueblo Paleta. Cada ma√±ana temprano, a las 7:00, entrena sus habilidades el√©ctricas junto a Ash. Le encanta comer exactamente 12 bayas dulces rojas para desayunar.',
                        question: '¬øCu√°ntas bayas rojas come Pikachu para desayunar cada ma√±ana?',
                        options: ['10 bayas', '12 bayas', '15 bayas', '8 bayas'],
                        correct: 1,
                        explanation: '¬°Excelente! El texto dice claramente que "come exactamente 12 bayas dulces rojas para desayunar".'
                    }
                ]
            }
        };

        // Logros disponibles
        const achievements = [
            { id: 'first_exercise', name: 'Primer Paso', description: 'Completa tu primer ejercicio', icon: 'üéØ', requirement: 1 },
            { id: 'math_master', name: 'Maestro Matem√°tico', description: 'Completa 20 ejercicios de matem√°ticas', icon: 'üßÆ', requirement: 20 },
            { id: 'reading_hero', name: 'H√©roe de la Lectura', description: 'Completa 20 ejercicios de comprensi√≥n lectora', icon: 'üìö', requirement: 20 },
            { id: 'english_expert', name: 'Experto en Ingl√©s', description: 'Completa 15 ejercicios de ingl√©s', icon: 'üá¨üáß', requirement: 15 },
            { id: 'perfect_day', name: 'D√≠a Perfecto', description: 'Completa todos los ejercicios de un d√≠a sin errores', icon: '‚≠ê', requirement: 1 },
            { id: 'streak_week', name: 'Racha Semanal', description: 'Mant√©n una racha de 7 d√≠as', icon: 'üî•', requirement: 7 },
            { id: 'multiplication_master', name: 'Maestro de la Multiplicaci√≥n', description: 'Completa 15 ejercicios de multiplicaci√≥n correctos', icon: '‚úñÔ∏è', requirement: 15 },
            { id: 'reading_champion', name: 'Campe√≥n de Lectura', description: 'Lee 25 textos completos', icon: 'üëë', requirement: 25 },
            { id: 'interactive_genius', name: 'Genio Interactivo', description: 'Completa 10 ejercicios interactivos', icon: 'üß©', requirement: 10 },
            { id: 'science_explorer', name: 'Explorador Cient√≠fico', description: 'Completa 10 ejercicios de ciencias', icon: 'üî¨', requirement: 10 },
            { id: 'speed_demon', name: 'Demonio de Velocidad', description: 'Completa un d√≠a en menos de 20 minutos', icon: '‚ö°', requirement: 1 },
            { id: 'hundred_club', name: 'Club de los 100', description: 'Alcanza 100 ejercicios completados', icon: 'üíØ', requirement: 100 }
        ];

        // Funciones de autenticaci√≥n
        async function login() {
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) {
                alert('¬°Por favor escribe tu nombre!');
                return;
            }
            
            appState.currentUser = username;
            await loadUserData();
            showMainApp();
        }

        function logout() {
            if (confirm('¬øEst√°s seguro de que quieres salir?')) {
                appState.currentUser = null;
                appState.userData = {};
                appState.allUsersData = {};
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }
        }

        // Gesti√≥n de datos con JSONBin
        async function loadUserData() {
            updateConnectionStatus('connecting');
            try {
                console.log('Cargando datos del usuario:', appState.currentUser);
                
                const response = await fetch(`${JSONBIN_CONFIG.apiUrl}/b/${JSONBIN_CONFIG.binId}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': JSONBIN_CONFIG.masterKey,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Datos recibidos:', data);
                    
                    const users = data.record?.users || {};
                    appState.allUsersData = users; // Guardar todos los usuarios para el ranking
                    appState.userData = users[appState.currentUser] || createNewUser();
                    
                    console.log('Datos del usuario cargados:', appState.userData);
                    console.log('Total de usuarios:', Object.keys(appState.allUsersData).length);
                    updateConnectionStatus('online');
                } else {
                    console.log('Error en respuesta, creando usuario nuevo');
                    appState.userData = createNewUser();
                    appState.allUsersData = {};
                    updateConnectionStatus('offline');
                }
            } catch (error) {
                console.error('Error cargando datos:', error);
                appState.userData = createNewUser();
                appState.allUsersData = {};
                updateConnectionStatus('offline');
            }
            
            updateLastSyncTime();
        }

        async function saveUserData() {
            try {
                console.log('Guardando datos del usuario:', appState.currentUser);
                updateConnectionStatus('saving');
                
                let allData = { users: {} };
                
                try {
                    const getCurrentResponse = await fetch(`${JSONBIN_CONFIG.apiUrl}/b/${JSONBIN_CONFIG.binId}/latest`, {
                        method: 'GET',
                        headers: {
                            'X-Master-Key': JSONBIN_CONFIG.masterKey,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (getCurrentResponse.ok) {
                        const currentData = await getCurrentResponse.json();
                        allData = currentData.record || { users: {} };
                    }
                } catch (error) {
                    console.log('No se pudieron obtener datos existentes, creando estructura nueva');
                }
                
                if (!allData.users) {
                    allData.users = {};
                }
                allData.users[appState.currentUser] = {
                    ...appState.userData,
                    lastSaved: new Date().toISOString()
                };
                
                // Actualizar datos locales para ranking
                appState.allUsersData = allData.users;
                
                const saveResponse = await fetch(`${JSONBIN_CONFIG.apiUrl}/b/${JSONBIN_CONFIG.binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_CONFIG.masterKey
                    },
                    body: JSON.stringify(allData)
                });
                
                if (saveResponse.ok) {
                    console.log('‚úÖ Datos guardados exitosamente en JSONBin');
                    updateConnectionStatus('online');
                    updateLastSyncTime();
                } else {
                    console.error('‚ùå Error al guardar:', saveResponse.status);
                    updateConnectionStatus('error');
                }
                
            } catch (error) {
                console.error('‚ùå Error guardando datos:', error);
                updateConnectionStatus('error');
            }
        }

        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            appState.connectionStatus = status;
            
            switch (status) {
                case 'online':
                    statusElement.textContent = '‚úÖ Conectado';
                    statusElement.className = 'connection-status online';
                    break;
                case 'offline':
                    statusElement.textContent = '‚ùå Sin conexi√≥n';
                    statusElement.className = 'connection-status offline';
                    break;
                case 'connecting':
                    statusElement.textContent = 'üîÑ Conectando...';
                    statusElement.className = 'connection-status offline';
                    break;
                case 'saving':
                    statusElement.textContent = 'üíæ Guardando...';
                    statusElement.className = 'connection-status online';
                    break;
                case 'error':
                    statusElement.textContent = '‚ö†Ô∏è Error de conexi√≥n';
                    statusElement.className = 'connection-status offline';
                    break;
            }
        }

        function updateLastSyncTime() {
            const now = new Date().toLocaleString('es-ES');
            const adminElement = document.getElementById('lastSync');
            if (adminElement) {
                adminElement.textContent = now;
            }
        }

        function createNewUser() {
            return {
                level: 1,
                totalPoints: 0,
                streak: 0,
                totalExercises: 0,
                correctAnswers: 0,
                exercisesByType: { 
                    math: 0, reading: 0, english: 0, interactive: 0, 
                    science: 0, geography: 0, history: 0, body: 0, 
                    technology: 0, grammar: 0, values: 0, nature: 0, money: 0 
                },
                exercisesByTheme: { pokemon: 0, titans: 0, football: 0, warframe: 0, mixed: 0 },
                multiplicationExercises: 0,
                textsRead: 0,
                interactiveExercises: 0,
                perfectDays: 0,
                fastestDay: null,
                completedExercises: {},
                achievements: [],
                sessionStartTime: null,
                created: new Date().toISOString(),
                lastActivity: new Date().toISOString()
            };
        }

        // SISTEMA DE RANKING
        function loadRanking() {
            console.log('Cargando ranking con datos:', appState.allUsersData);
            
            if (Object.keys(appState.allUsersData).length === 0) {
                showNoRankingData();
                return;
            }
            
            const users = Object.entries(appState.allUsersData).map(([username, userData]) => ({
                username,
                ...userData,
                accuracy: userData.totalExercises > 0 ? Math.round((userData.correctAnswers / userData.totalExercises) * 100) : 0,
                achievementCount: userData.achievements ? userData.achievements.length : 0
            }));
            
            // Ordenar seg√∫n el filtro actual
            const sortedUsers = sortUsersByFilter(users, appState.currentRankingFilter);
            
            // Mostrar podio (top 3)
            showPodium(sortedUsers.slice(0, 3));
            
            // Mostrar tabla completa
            showRankingTable(sortedUsers);
        }

        function sortUsersByFilter(users, filter) {
            switch (filter) {
                case 'achievements':
                    return users.sort((a, b) => {
                        if (b.achievementCount !== a.achievementCount) {
                            return b.achievementCount - a.achievementCount;
                        }
                        return b.totalPoints - a.totalPoints; // Desempate por puntos
                    });
                case 'points':
                    return users.sort((a, b) => b.totalPoints - a.totalPoints);
                case 'level':
                    return users.sort((a, b) => {
                        if (b.level !== a.level) {
                            return b.level - a.level;
                        }
                        return b.totalPoints - a.totalPoints; // Desempate por puntos
                    });
                case 'exercises':
                    return users.sort((a, b) => b.totalExercises - a.totalExercises);
                case 'accuracy':
                    return users.sort((a, b) => {
                        if (b.accuracy !== a.accuracy) {
                            return b.accuracy - a.accuracy;
                        }
                        return b.totalExercises - a.totalExercises; // Desempate por cantidad
                    });
                case 'streak':
                    return users.sort((a, b) => {
                        if (b.streak !== a.streak) {
                            return b.streak - a.streak;
                        }
                        return b.totalPoints - a.totalPoints; // Desempate por puntos
                    });
                default:
                    return users;
            }
        }

        function showPodium(topUsers) {
            const podiumContainer = document.getElementById('podiumContainer');
            podiumContainer.innerHTML = '';
            
            if (topUsers.length === 0) {
                return;
            }
            
            const podiumData = [
                { user: topUsers[1], place: 'second', crown: 'ü•à', height: '150px' },
                { user: topUsers[0], place: 'first', crown: 'üëë', height: '180px' },
                { user: topUsers[2], place: 'third', crown: 'ü•â', height: '120px' }
            ];
            
            podiumData.forEach((data, index) => {
                if (!data.user) return;
                
                const place = document.createElement('div');
                place.className = `podium-place ${data.place}`;
                
                const isCurrentUser = data.user.username === appState.currentUser;
                const borderStyle = isCurrentUser ? 'border: 3px solid #ffc107;' : '';
                
                place.innerHTML = `
                    <div class="podium-crown">${data.crown}</div>
                    <div class="podium-avatar" style="${borderStyle}">
                        ${data.user.username.charAt(0).toUpperCase()}
                    </div>
                    <h4 style="margin: 10px 0; ${isCurrentUser ? 'color: #ffc107; font-weight: bold;' : ''}">${data.user.username}</h4>
                    <div style="font-size: 14px; color: #666;">
                        ${getFilterDisplayValue(data.user, appState.currentRankingFilter)}
                    </div>
                    <div style="margin-top: 8px; font-size: 12px;">
                        üèÜ ${data.user.achievementCount} logros
                    </div>
                `;
                
                podiumContainer.appendChild(place);
            });
        }

        function showRankingTable(users) {
            const tableContainer = document.getElementById('rankingTableContainer');
            
            if (users.length === 0) {
                tableContainer.innerHTML = '<div class="no-data">No hay usuarios registrados todav√≠a.</div>';
                return;
            }
            
            const table = document.createElement('div');
            table.className = 'ranking-table';
            
            // Header
            const header = document.createElement('div');
            header.className = 'ranking-header';
            header.innerHTML = `
                <span>Pos.</span>
                <span>Entrenador</span>
                <span>Nivel</span>
                <span>Puntos</span>
                <span>${getFilterHeaderName(appState.currentRankingFilter)}</span>
                <span>Logros</span>
            `;
            table.appendChild(header);
            
            // Filas de usuarios
            users.forEach((user, index) => {
                const row = document.createElement('div');
                row.className = `ranking-row ${user.username === appState.currentUser ? 'current-user' : ''}`;
                
                const position = index + 1;
                let positionClass = '';
                let positionIcon = position;
                
                if (position === 1) {
                    positionClass = 'first';
                    positionIcon = 'üèÜ';
                } else if (position === 2) {
                    positionClass = 'second';
                    positionIcon = 'ü•à';
                } else if (position === 3) {
                    positionClass = 'third';
                    positionIcon = 'ü•â';
                }
                
                const achievementsPreview = user.achievements ? user.achievements.slice(0, 6).map(achievementId => {
                    const achievement = achievements.find(a => a.id === achievementId);
                    return achievement ? `<div class="achievement-mini" title="${achievement.name}">${achievement.icon}</div>` : '';
                }).join('') : '';
                
                row.innerHTML = `
                    <div class="position ${positionClass}">${positionIcon}</div>
                    <div class="user-name">
                        <div class="user-avatar">${user.username.charAt(0).toUpperCase()}</div>
                        <span style="${user.username === appState.currentUser ? 'font-weight: bold; color: #ffc107;' : ''}">${user.username}</span>
                    </div>
                    <div class="stat-value">${user.level}</div>
                    <div class="stat-value">${user.totalPoints}</div>
                    <div class="stat-value">${getFilterDisplayValue(user, appState.currentRankingFilter)}</div>
                    <div class="achievements-preview">${achievementsPreview}</div>
                `;
                
                table.appendChild(row);
            });
            
            tableContainer.innerHTML = '';
            tableContainer.appendChild(table);
        }

        function getFilterHeaderName(filter) {
            const names = {
                achievements: 'Logros',
                points: 'Puntos',
                level: 'Nivel',
                exercises: 'Ejercicios',
                accuracy: 'Precisi√≥n',
                streak: 'Racha'
            };
            return names[filter] || 'Valor';
        }

        function getFilterDisplayValue(user, filter) {
            switch (filter) {
                case 'achievements':
                    return `${user.achievementCount} üèÜ`;
                case 'points':
                    return `${user.totalPoints} üí∞`;
                case 'level':
                    return `${user.level} üìà`;
                case 'exercises':
                    return `${user.totalExercises} üìö`;
                case 'accuracy':
                    return `${user.accuracy}% üéØ`;
                case 'streak':
                    return `${user.streak} üî•`;
                default:
                    return '0';
            }
        }

        function setRankingFilter(filter) {
            appState.currentRankingFilter = filter;
            
            // Actualizar botones
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Recargar ranking
            loadRanking();
        }

        function showNoRankingData() {
            const podiumContainer = document.getElementById('podiumContainer');
            const tableContainer = document.getElementById('rankingTableContainer');
            
            podiumContainer.innerHTML = '';
            tableContainer.innerHTML = `
                <div class="no-data">
                    <h3>üåü ¬°S√© el primero en el ranking!</h3>
                    <p>Completa algunos ejercicios para aparecer en el ranking de entrenadores.</p>
                </div>
            `;
        }

        // Interfaz principal
        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            updateUserInterface();
            generateWeeks();
            
            const adminUser = document.getElementById('currentUserAdmin');
            if (adminUser) {
                adminUser.textContent = appState.currentUser;
            }
        }

        function updateUserInterface() {
            document.getElementById('userName').textContent = appState.currentUser;
            document.getElementById('userLevel').textContent = appState.userData.level;
            document.getElementById('totalPoints').textContent = appState.userData.totalPoints;
            document.getElementById('streak').textContent = appState.userData.streak;
            
            const accuracy = appState.userData.totalExercises > 0 
                ? Math.round((appState.userData.correctAnswers / appState.userData.totalExercises) * 100)
                : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';
        }

        // Gesti√≥n de pesta√±as
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName + 'Tab').style.display = 'block';
            event.target.classList.add('active');
            
            if (tabName === 'achievements') {
                loadAchievements();
            } else if (tabName === 'stats') {
                loadStats();
            } else if (tabName === 'ranking') {
                loadRanking();
            }
        }

        // Generaci√≥n de semanas
        function generateWeeks() {
            const weekGrid = document.getElementById('weekGrid');
            weekGrid.innerHTML = '';
            
            const availableWeeks = Object.keys(exerciseDatabase).length;
            
            for (let week = 1; week <= availableWeeks; week++) {
                const weekCard = document.createElement('div');
                weekCard.className = 'week-card';
                weekCard.onclick = () => showWeek(week);
                
                const completedDays = getCompletedDaysInWeek(week);
                const totalDays = 5;
                
                weekCard.innerHTML = `
                    <h3>üóìÔ∏è Semana ${week}</h3>
                    <p>Progreso: ${completedDays}/${totalDays} d√≠as completados</p>
                    <div style="margin-top: 15px;">
                        <div style="background: rgba(255,255,255,0.3); height: 8px; border-radius: 4px;">
                            <div style="background: white; height: 100%; width: ${(completedDays/totalDays)*100}%; border-radius: 4px;"></div>
                        </div>
                    </div>
                    <p style="margin-top: 10px; font-size: 14px;">üéØ Ejercicios variados</p>
                `;
                
                weekGrid.appendChild(weekCard);
            }
        }

        function getCompletedDaysInWeek(week) {
            let completed = 0;
            for (let day = 1; day <= 5; day++) {
                const dayKey = `week${week}_day${day}`;
                if (appState.userData.completedExercises[dayKey]) {
                    completed++;
                }
            }
            return completed;
        }

        function showWeek(weekNumber) {
            document.getElementById('weekGrid').style.display = 'none';
            document.getElementById('dayView').style.display = 'block';
            
            const dayGrid = document.getElementById('dayGrid');
            dayGrid.innerHTML = '';
            
            const days = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes'];
            
            for (let day = 1; day <= 5; day++) {
                const dayKey = `week${weekNumber}_day${day}`;
                const isCompleted = appState.userData.completedExercises[dayKey];
                
                const dayCard = document.createElement('div');
                dayCard.className = 'day-card';
                if (isCompleted) {
                    dayCard.style.background = 'linear-gradient(135deg, #d4edda, #c3e6cb)';
                    dayCard.style.borderLeft = '5px solid #28a745';
                }
                
                dayCard.onclick = () => startDay(weekNumber, day);
                
                const exercises = getDayExercises(weekNumber, day);
                const exerciseList = exercises.map(ex => `
                    <div class="exercise-item">
                        <span>${getExerciseIcon(ex.type)} ${getExerciseTitle(ex.type, ex.theme)}</span>
                        <span>${isCompleted ? '‚úÖ' : '‚è≥'}</span>
                    </div>
                `).join('');
                
                const timeEstimate = Math.ceil(exercises.length * 4);
                
                dayCard.innerHTML = `
                    <h4>${days[day-1]} - D√≠a ${day}</h4>
                    <p style="color: #666; margin-bottom: 15px;">üïê ~${timeEstimate} minutos | ${exercises.length} ejercicios</p>
                    <div class="exercise-list">
                        ${exerciseList}
                    </div>
                    ${isCompleted ? '<div style="margin-top: 15px; color: #28a745; font-weight: bold;">üéâ ¬°D√≠a completado!</div>' : ''}
                `;
                
                dayGrid.appendChild(dayCard);
            }
        }

        function backToWeeks() {
            document.getElementById('weekGrid').style.display = 'grid';
            document.getElementById('dayView').style.display = 'none';
        }

        function getDayExercises(week, day) {
            const weekKey = `week${week}`;
            const dayKey = `day${day}`;
            
            if (exerciseDatabase[weekKey] && exerciseDatabase[weekKey][dayKey]) {
                return exerciseDatabase[weekKey][dayKey];
            }
            
            return exerciseDatabase.week1.day1.slice(0, 2);
        }

        function getExerciseIcon(type) {
            const icons = {
                math: 'üßÆ',
                reading: 'üìñ',
                english: 'üá¨üáß',
                interactive: 'üß©',
                science: 'üî¨',
                geography: 'üåç',
                history: 'üèõÔ∏è',
                body: 'ü´Ä',
                technology: 'üíª',
                grammar: '‚úèÔ∏è',
                values: '‚ù§Ô∏è',
                nature: 'üå±',
                money: 'üí∞'
            };
            return icons[type] || 'üìù';
        }

        function getExerciseTitle(type, theme) {
            const titles = {
                math: 'Matem√°ticas',
                reading: 'Comprensi√≥n Lectora',
                english: 'Ingl√©s'
            };
            
            const themes = {
                pokemon: 'Pok√©mon',
                titans: 'Titanes',
                football: 'F√∫tbol',
                warframe: 'Warframe'
            };
            
            return `${titles[type]} - ${themes[theme] || 'General'}`;
        }

        // Sistema de ejercicios b√°sico (simplificado por espacio)
        function startDay(week, day) {
            alert(`¬°Comenzando ejercicios del d√≠a ${day} de la semana ${week}!`);
        }

        // Sistema de logros b√°sico
        function loadAchievements() {
            const grid = document.getElementById('achievementGrid');
            grid.innerHTML = '';
            
            achievements.forEach(achievement => {
                const isUnlocked = appState.userData.achievements.includes(achievement.id);const card = document.createElement('div');
                card.className = `achievement-card ${isUnlocked ? 'unlocked' : ''}`;
                
                card.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <h4>${achievement.name}</h4>
                    <p>${achievement.description}</p>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        ${isUnlocked ? '‚úÖ Desbloqueado' : 'üîí Bloqueado'}
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        // Estad√≠sticas b√°sicas
        function loadStats() {
            const content = document.getElementById('statsContent');
            const userData = appState.userData;
            
            const accuracy = userData.totalExercises > 0 
                ? Math.round((userData.correctAnswers / userData.totalExercises) * 100)
                : 0;
            
            // Calcular posici√≥n en ranking
            const allUsers = Object.entries(appState.allUsersData);
            const sortedByAchievements = allUsers.sort((a, b) => {
                const aAchievements = a[1].achievements ? a[1].achievements.length : 0;
                const bAchievements = b[1].achievements ? b[1].achievements.length : 0;
                if (bAchievements !== aAchievements) {
                    return bAchievements - aAchievements;
                }
                return (b[1].totalPoints || 0) - (a[1].totalPoints || 0);
            });
            
            const userRankPosition = sortedByAchievements.findIndex(([username]) => username === appState.currentUser) + 1;
            const totalUsers = allUsers.length;
            
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="stat-card" style="padding: 20px;">
                        <h3>üìä Estad√≠sticas Generales</h3>
                        <p><strong>Ejercicios totales:</strong> ${userData.totalExercises}</p>
                        <p><strong>Respuestas correctas:</strong> ${userData.correctAnswers}</p>
                        <p><strong>Precisi√≥n:</strong> ${accuracy}%</p>
                        <p><strong>Puntos totales:</strong> ${userData.totalPoints}</p>
                        <p><strong>Racha actual:</strong> ${userData.streak} d√≠as</p>
                        <p><strong>Nivel:</strong> ${userData.level}</p>
                        <p><strong>D√≠as perfectos:</strong> ${userData.perfectDays || 0}</p>
                        <p><strong>D√≠a m√°s r√°pido:</strong> ${userData.fastestDay ? userData.fastestDay + ' minutos' : 'No disponible'}</p>
                    </div>
                    
                    <div class="stat-card" style="padding: 20px;">
                        <h3>üèÜ Tu Posici√≥n en el Ranking</h3>
                        <div style="text-align: center; margin: 20px 0;">
                            <div style="font-size: 48px; color: #667eea; font-weight: bold;">
                                ${userRankPosition > 0 ? `#${userRankPosition}` : 'N/A'}
                            </div>
                            <div style="font-size: 16px; color: #666; margin-top: 5px;">
                                de ${totalUsers} entrenadores
                            </div>
                        </div>
                        <p><strong>üèÜ Logros desbloqueados:</strong> ${userData.achievements.length}/${achievements.length}</p>
                        <p><strong>üéØ Percentil:</strong> ${userRankPosition > 0 && totalUsers > 1 ? Math.round(((totalUsers - userRankPosition) / (totalUsers - 1)) * 100) : 0}%</p>
                        ${userRankPosition <= 3 && userRankPosition > 0 ? `
                            <div style="margin-top: 15px; padding: 10px; background: linear-gradient(135deg, #ffd700, #ffed4e); border-radius: 8px; text-align: center;">
                                <strong>üéâ ¬°Est√°s en el podio!</strong>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="stat-card" style="padding: 20px;">
                        <h3>üìö Por Materia</h3>
                        <p><strong>üßÆ Matem√°ticas:</strong> ${userData.exercisesByType.math || 0}</p>
                        <p><strong>üìñ Comprensi√≥n Lectora:</strong> ${userData.exercisesByType.reading || 0}</p>
                        <p><strong>üá¨üáß Ingl√©s:</strong> ${userData.exercisesByType.english || 0}</p>
                        <p><strong>üß© Interactivos:</strong> ${userData.exercisesByType.interactive || 0}</p>
                        <p><strong>üî¨ Ciencias:</strong> ${userData.exercisesByType.science || 0}</p>
                        <p><strong>üåç Geograf√≠a:</strong> ${userData.exercisesByType.geography || 0}</p>
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                            <p><strong>‚úñÔ∏è Multiplicaciones:</strong> ${userData.multiplicationExercises || 0}</p>
                            <p><strong>üìñ Textos le√≠dos:</strong> ${userData.textsRead || 0}</p>
                        </div>
                    </div>
                    
                    <div class="stat-card" style="padding: 20px;">
                        <h3>üéÆ Por Tema Favorito</h3>
                        <p><strong>üî¥ Pok√©mon:</strong> ${userData.exercisesByTheme.pokemon || 0}</p>
                        <p><strong>‚öîÔ∏è Titanes:</strong> ${userData.exercisesByTheme.titans || 0}</p>
                        <p><strong>‚öΩ F√∫tbol:</strong> ${userData.exercisesByTheme.football || 0}</p>
                        <p><strong>üî´ Warframe:</strong> ${userData.exercisesByTheme.warframe || 0}</p>
                        <p><strong>üéØ Variado:</strong> ${userData.exercisesByTheme.mixed || 0}</p>
                    </div>
                </div>
                
                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <h3>üìà Comparaci√≥n con Otros Entrenadores</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                        ${generateComparisonStats(userData, allUsers)}
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 10px; border-left: 4px solid #2196f3;">
                    <h4>üìù Informaci√≥n de Cuenta</h4>
                    <p><strong>Usuario:</strong> ${appState.currentUser}</p>
                    <p><strong>Cuenta creada:</strong> ${userData.created ? new Date(userData.created).toLocaleDateString('es-ES') : 'Fecha no disponible'}</p>
                    <p><strong>√öltima actividad:</strong> ${userData.lastActivity ? new Date(userData.lastActivity).toLocaleString('es-ES') : 'No disponible'}</p>
                    <p><strong>Estado de guardado:</strong> ${appState.connectionStatus === 'online' ? '‚úÖ Sincronizado' : '‚ùå Sin sincronizar'}</p>
                </div>
            `;
        }

        function generateComparisonStats(userData, allUsers) {
            if (allUsers.length <= 1) {
                return '<div style="text-align: center; color: #666; grid-column: 1 / -1;">Necesitas m√°s entrenadores para comparar estad√≠sticas</div>';
            }

            const stats = {
                totalPoints: { values: [], label: 'Puntos', icon: 'üí∞' },
                totalExercises: { values: [], label: 'Ejercicios', icon: 'üìö' },
                accuracy: { values: [], label: 'Precisi√≥n', icon: 'üéØ' },
                achievements: { values: [], label: 'Logros', icon: 'üèÜ' }
            };

            // Recopilar datos de todos los usuarios
            allUsers.forEach(([username, user]) => {
                stats.totalPoints.values.push(user.totalPoints || 0);
                stats.totalExercises.values.push(user.totalExercises || 0);
                const accuracy = user.totalExercises > 0 ? Math.round((user.correctAnswers / user.totalExercises) * 100) : 0;
                stats.accuracy.values.push(accuracy);
                stats.achievements.values.push(user.achievements ? user.achievements.length : 0);
            });

            // Calcular estad√≠sticas comparativas
            const userStats = {
                totalPoints: userData.totalPoints || 0,
                totalExercises: userData.totalExercises || 0,
                accuracy: userData.totalExercises > 0 ? Math.round((userData.correctAnswers / userData.totalExercises) * 100) : 0,
                achievements: userData.achievements ? userData.achievements.length : 0
            };

            let html = '';
            Object.entries(stats).forEach(([key, data]) => {
                const average = data.values.reduce((a, b) => a + b, 0) / data.values.length;
                const userValue = userStats[key];
                const percentile = calculatePercentile(userValue, data.values);
                const isAboveAverage = userValue >= average;

                html += `
                    <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #ddd;">
                        <div style="font-size: 24px; margin-bottom: 5px;">${data.icon}</div>
                        <h4>${data.label}</h4>
                        <div style="font-size: 20px; color: #667eea; margin: 8px 0;">${userValue}${key === 'accuracy' ? '%' : ''}</div>
                        <div style="font-size: 12px; color: #666;">
                            Promedio: ${Math.round(average)}${key === 'accuracy' ? '%' : ''}<br>
                            Percentil: ${percentile}%
                        </div>
                        <div style="margin-top: 8px;">
                            ${isAboveAverage ? 
                                '<span style="color: #28a745; font-size: 12px;">üìà Sobre la media</span>' : 
                                '<span style="color: #ffc107; font-size: 12px;">üìä Bajo la media</span>'
                            }
                        </div>
                    </div>
                `;
            });

            return html;
        }

        function calculatePercentile(value, allValues) {
            const sorted = allValues.sort((a, b) => a - b);
            const rank = sorted.filter(v => v <= value).length;
            return Math.round((rank / sorted.length) * 100);
        }

        // Sistema de recompensas
        function showReward(title, icon, message) {
            document.getElementById('rewardTitle').textContent = title;
            document.getElementById('rewardIcon').textContent = icon;
            document.getElementById('rewardMessage').textContent = message;
            document.getElementById('rewardPopup').style.display = 'block';
        }

        function closeReward() {
            document.getElementById('rewardPopup').style.display = 'none';
        }

        // Funciones de administraci√≥n
        async function testConnection() {
            updateConnectionStatus('connecting');
            try {
                const response = await fetch(`${JSONBIN_CONFIG.apiUrl}/b/${JSONBIN_CONFIG.binId}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': JSONBIN_CONFIG.masterKey
                    }
                });
                
                if (response.ok) {
                    updateConnectionStatus('online');
                    alert('‚úÖ Conexi√≥n exitosa con JSONBin.io');
                    // Recargar datos para actualizar ranking
                    await loadUserData();
                } else {
                    updateConnectionStatus('error');
                    alert('‚ùå Error de conexi√≥n: ' + response.status);
                }
            } catch (error) {
                updateConnectionStatus('error');
                alert('‚ùå Error de red: ' + error.message);
            }
        }

        function resetProgress() {
            if (confirm('¬øEst√°s seguro de que quieres reiniciar todo el progreso? Esta acci√≥n no se puede deshacer.')) {
                appState.userData = createNewUser();
                saveUserData();
                updateUserInterface();
                generateWeeks();
                alert('Progreso reiniciado correctamente.');
            }
        }

        function exportData() {
            const dataToExport = {
                user: appState.currentUser,
                data: appState.userData,
                ranking: {
                    position: calculateUserRankPosition(),
                    totalUsers: Object.keys(appState.allUsersData).length
                },
                exportDate: new Date().toISOString(),
                summary: {
                    totalExercises: appState.userData.totalExercises,
                    accuracy: appState.userData.totalExercises > 0 ? Math.round((appState.userData.correctAnswers / appState.userData.totalExercises) * 100) : 0,
                    level: appState.userData.level,
                    achievements: appState.userData.achievements.length,
                    connectionStatus: appState.connectionStatus,
                    perfectDays: appState.userData.perfectDays || 0,
                    fastestDay: appState.userData.fastestDay || null
                }
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `academia_pokemon_${appState.currentUser}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function calculateUserRankPosition() {
            const allUsers = Object.entries(appState.allUsersData);
            const sortedByAchievements = allUsers.sort((a, b) => {
                const aAchievements = a[1].achievements ? a[1].achievements.length : 0;
                const bAchievements = b[1].achievements ? b[1].achievements.length : 0;
                if (bAchievements !== aAchievements) {
                    return bAchievements - aAchievements;
                }
                return (b[1].totalPoints || 0) - (a[1].totalPoints || 0);
            });
            
            return sortedByAchievements.findIndex(([username]) => username === appState.currentUser) + 1;
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéÆ Academia Pokemon iniciada - Versi√≥n con Ranking');
            console.log('üì° Configuraci√≥n JSONBin:', {
                binId: JSONBIN_CONFIG.binId,
                apiUrl: JSONBIN_CONFIG.apiUrl
            });
            
            updateConnectionStatus('offline');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            
            // Event listener para Enter en el input de login
            document.getElementById('usernameInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
        });

        // Funciones simplificadas para ejercicios (por limitaciones de espacio)
        function selectOption(selectedIndex) {
            // L√≥gica simplificada
            alert('Funci√≥n de ejercicios simplificada para demo del ranking');
        }

        function nextExercise() {
            alert('Funci√≥n de ejercicios simplificada para demo del ranking');
        }

        function completeDay() {
            alert('Funci√≥n de ejercicios simplificada para demo del ranking');
        }

        function closeExercise() {
            document.getElementById('exerciseModal').style.display = 'none';
        }

        function showExercise() {
            alert('Funci√≥n de ejercicios simplificada para demo del ranking');
        }

        function showNormalExercise(exercise) {
            alert('Funci√≥n de ejercicios simplificada para demo del ranking');
        }

        function showInteractiveExercise(exercise) {
            alert('Funci√≥n de ejercicios simplificada para demo del ranking');
        }

        function createSequenceExercise(exercise) {
            alert('Funci√≥n de ejercicios simplificada para demo del ranking');
        }

        function createDragDropExercise(exercise) {
            alert('Funci√≥n de ejercicios simplificada para demo del ranking');
        }

        function handleInteractiveResult(isCorrect, explanation) {
            alert('Funci√≥n de ejercicios simplificada para demo del ranking');
        }

        function checkAchievements() {
            // L√≥gica simplificada
        }

        function showDayComplete(correct, total, duration) {
            alert(`D√≠a completado: ${correct}/${total} en ${duration} minutos`);
        }
    </script>
</body>
</html>
