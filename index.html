<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ Academia Pokemon - ¬°Aprende Jugando!</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One:wght@400&family=Nunito:wght@400;600;700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 25%, #45b7d1 50%, #96ceb4 75%, #ffeaa7 100%);
            background-size: 400% 400%;
            animation: gradientShift 8s ease infinite;
            min-height: 100vh;
            color: #2d3436;
            overflow-x: hidden;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            position: relative;
        }

        .login-card {
            background: white;
            padding: 50px;
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            text-align: center;
            max-width: 500px;
            width: 100%;
            position: relative;
            z-index: 2;
            border: 5px solid transparent;
            background-clip: padding-box;
        }

        .login-card::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
            border-radius: 35px;
            z-index: -1;
        }

        .login-card h1 {
            font-family: 'Fredoka One', cursive;
            color: #ff6b6b;
            margin-bottom: 20px;
            font-size: 3em;
            text-shadow: 3px 3px 0px #fff;
        }

        .login-card p {
            font-size: 18px;
            color: #636e72;
            margin-bottom: 30px;
            font-weight: 600;
        }

        .login-card input {
            width: 100%;
            padding: 20px;
            margin: 15px 0;
            border: 3px solid #ddd;
            border-radius: 20px;
            font-size: 18px;
            font-family: 'Nunito', sans-serif;
            font-weight: 600;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .login-card input:focus {
            outline: none;
            border-color: #ff6b6b;
            transform: scale(1.02);
            background: white;
        }

        .login-card button {
            width: 100%;
            padding: 20px;
            background: linear-gradient(45deg, #ff6b6b, #fd79a8);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 20px;
            font-weight: 800;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
            font-family: 'Nunito', sans-serif;
        }

        .login-card button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(255, 107, 107, 0.6);
        }

        .main-app {
            display: none;
        }

        .header {
            background: white;
            padding: 25px;
            border-radius: 25px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            border: 3px solid #fdcb6e;
            flex-wrap: wrap;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 35px;
            color: white;
            font-weight: 800;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            border: 4px solid white;
        }

        .user-info h2 {
            font-family: 'Fredoka One', cursive;
            font-size: 24px;
            color: #2d3436;
            margin: 0;
        }

        .user-info p {
            font-size: 16px;
            color: #636e72;
            margin: 5px 0 0 0;
            font-weight: 600;
        }

        .stats {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 20px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(116, 185, 255, 0.3);
            min-width: 100px;
            transition: transform 0.3s;
            border: 3px solid white;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card:nth-child(2) {
            background: linear-gradient(135deg, #55efc4, #00b894);
            box-shadow: 0 8px 25px rgba(85, 239, 196, 0.3);
        }

        .stat-card:nth-child(3) {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
            box-shadow: 0 8px 25px rgba(253, 203, 110, 0.3);
        }

        .stat-card h3 {
            font-size: 28px;
            font-weight: 800;
            margin: 5px 0;
            font-family: 'Fredoka One', cursive;
        }

        .stat-card p {
            font-size: 14px;
            opacity: 0.95;
            font-weight: 700;
        }

        .tab-navigation {
            background: white;
            padding: 15px;
            border-radius: 25px;
            margin-bottom: 25px;
            display: flex;
            gap: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            border: 3px solid #4ecdc4;
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-tab {
            padding: 15px 30px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 3px solid #dfe6e9;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 800;
            font-size: 16px;
            color: #2d3436;
            font-family: 'Nunito', sans-serif;
        }

        .nav-tab:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #ff6b6b, #fd79a8);
            color: white;
            border-color: #d63031;
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .calendar-wrapper {
            background: white;
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.1);
            border: 4px solid #74b9ff;
        }

        .calendar-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .calendar-header h2 {
            font-family: 'Fredoka One', cursive;
            font-size: 32px;
            color: #2d3436;
            margin-bottom: 10px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .day-header {
            font-family: 'Fredoka One', cursive;
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            border-radius: 15px;
            font-size: 16px;
            border: 3px solid white;
        }

        .day-cell {
            aspect-ratio: 1;
            border: 4px solid #dfe6e9;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            position: relative;
            overflow: hidden;
        }

        .day-cell:hover:not(.disabled):not(.empty) {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .day-cell.empty {
            opacity: 0.3;
            cursor: default;
            background: #f8f9fa;
        }

        .day-cell.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f8f9fa;
        }

        .day-cell.recoverable {
            background: linear-gradient(135deg, #fab1a0, #ff7675);
            border-color: #d63031;
            cursor: pointer;
            animation: pulseRecoverable 2s infinite;
        }

        @keyframes pulseRecoverable {
            0%, 100% { box-shadow: 0 0 15px rgba(255, 118, 117, 0.4); }
            50% { box-shadow: 0 0 25px rgba(255, 118, 117, 0.7); }
        }

        .day-cell.recoverable:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(255, 118, 117, 0.8);
        }

        .day-cell.completed {
            background: linear-gradient(135deg, #55efc4, #00b894);
            border-color: #00b894;
            animation: pulseGlow 2s infinite;
        }

        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 184, 148, 0.5); }
            50% { box-shadow: 0 0 40px rgba(0, 184, 148, 0.8); }
        }

        .day-cell.current {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
            border-color: #d63031;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .day-number {
            font-family: 'Fredoka One', cursive;
            font-size: 24px;
            font-weight: 800;
            color: #2d3436;
        }

        .day-cell.completed .day-number,
        .day-cell.current .day-number,
        .day-cell.recoverable .day-number {
            color: white;
        }

        .day-status {
            font-size: 30px;
            margin-top: 5px;
        }

        .exercise-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }

        .exercise-content {
            background: white;
            padding: 40px;
            border-radius: 30px;
            max-width: 900px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border: 5px solid #4ecdc4;
            position: relative;
            margin: 20px auto;
            max-height: 90vh;
            overflow-y: auto;
        }

        .exercise-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .exercise-header h3 {
            font-family: 'Fredoka One', cursive;
            font-size: 32px;
            color: #2d3436;
            margin-bottom: 15px;
        }

        .subject-badge {
            display: inline-block;
            padding: 12px 25px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 18px;
            margin: 5px;
            border: 3px solid white;
        }

        .subject-badge.math {
            background: linear-gradient(135deg, #ff6b6b, #fd79a8);
            color: white;
        }

        .subject-badge.reading {
            background: linear-gradient(135deg, #4ecdc4, #45b7d1);
            color: white;
        }

        .subject-badge.science {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
        }

        .subject-badge.social {
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
            color: white;
        }

        .instruction-box {
            background: linear-gradient(135deg, #dfe6e9, #b2bec3);
            padding: 25px;
            border-radius: 20px;
            margin: 20px 0;
            border: 4px solid #636e72;
        }

        .instruction-box h4 {
            font-family: 'Fredoka One', cursive;
            font-size: 22px;
            color: #2d3436;
            margin-bottom: 15px;
        }

        .instruction-box p {
            font-size: 18px;
            font-weight: 700;
            color: #2d3436;
            line-height: 1.6;
        }

        .reading-passage {
            background: linear-gradient(135deg, #fff9e6, #ffeaa7);
            padding: 30px;
            border-radius: 20px;
            margin: 20px 0;
            border: 4px solid #fdcb6e;
            font-size: 18px;
            line-height: 2;
            font-weight: 600;
            color: #2d3436;
            max-height: 400px;
            overflow-y: auto;
        }

        .reading-passage h4 {
            font-family: 'Fredoka One', cursive;
            font-size: 24px;
            margin-bottom: 20px;
            color: #e17055;
            text-align: center;
        }

        .reading-passage p {
            margin-bottom: 15px;
        }

        .question-container {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 30px;
            border-radius: 25px;
            margin: 25px 0;
            border: 4px solid #dfe6e9;
        }

        .question-text {
            font-size: 22px;
            font-weight: 700;
            color: #2d3436;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .options-container {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .option-btn {
            padding: 20px;
            background: white;
            border: 4px solid #dfe6e9;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 18px;
            font-weight: 700;
            text-align: left;
            color: #2d3436;
            font-family: 'Nunito', sans-serif;
        }

        .option-btn:hover {
            transform: translateX(10px);
            border-color: #74b9ff;
            box-shadow: 0 8px 25px rgba(116, 185, 255, 0.3);
        }

        .option-btn.selected {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            border-color: #0984e3;
        }

        .option-btn.correct {
            background: linear-gradient(135deg, #55efc4, #00b894);
            color: white;
            border-color: #00b894;
        }

        .option-btn.incorrect {
            background: linear-gradient(135deg, #ff7675, #d63031);
            color: white;
            border-color: #d63031;
        }

        .hint-box {
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
            padding: 20px;
            border-radius: 20px;
            margin: 20px 0;
            border: 4px solid #e17055;
            display: none;
        }

        .hint-box.visible {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hint-text {
            font-size: 18px;
            font-weight: 700;
            color: #2d3436;
        }

        .feedback-box {
            padding: 25px;
            border-radius: 20px;
            margin: 20px 0;
            font-size: 18px;
            font-weight: 700;
            border: 4px solid;
            display: none;
            line-height: 1.6;
        }

        .feedback-box.visible {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .feedback-box.correct {
            background: linear-gradient(135deg, #55efc4, #00b894);
            color: white;
            border-color: #00b894;
        }

        .feedback-box.incorrect {
            background: linear-gradient(135deg, #ff7675, #d63031);
            color: white;
            border-color: #d63031;
        }

        .explanation-box {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding: 25px;
            border-radius: 20px;
            margin: 20px 0;
            border: 4px solid #2196f3;
            display: none;
            font-size: 17px;
            line-height: 1.7;
            font-weight: 600;
            color: #1565c0;
        }

        .explanation-box.visible {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .explanation-box h4 {
            font-family: 'Fredoka One', cursive;
            font-size: 22px;
            margin-bottom: 15px;
            color: #0d47a1;
        }

        .exercise-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .exercise-btn {
            flex: 1;
            min-width: 150px;
            padding: 18px;
            border: none;
            border-radius: 20px;
            font-size: 18px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Nunito', sans-serif;
        }

        .exercise-btn.primary {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            box-shadow: 0 8px 25px rgba(116, 185, 255, 0.4);
        }

        .exercise-btn.primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(116, 185, 255, 0.6);
        }

        .exercise-btn.secondary {
            background: linear-gradient(135deg, #dfe6e9, #b2bec3);
            color: #2d3436;
        }

        .exercise-btn.secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .exercise-btn.success {
            background: linear-gradient(135deg, #55efc4, #00b894);
            color: white;
            box-shadow: 0 8px 25px rgba(0, 184, 148, 0.4);
        }

        .exercise-btn.success:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0, 184, 148, 0.6);
        }

        .exercise-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .progress-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }

        .progress-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #dfe6e9;
            border: 3px solid #b2bec3;
            transition: all 0.3s;
        }

        .progress-dot.completed {
            background: linear-gradient(135deg, #55efc4, #00b894);
            border-color: #00b894;
        }

        .progress-dot.current {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
            border-color: #e17055;
            transform: scale(1.3);
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ff7675, #d63031);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 800;
            box-shadow: 0 8px 20px rgba(214, 48, 49, 0.4);
        }

        .close-modal:hover {
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 12px 30px rgba(214, 48, 49, 0.6);
        }

        .achievement-unlock {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 50px;
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            z-index: 2000;
            text-align: center;
            border: 5px solid #fdcb6e;
            display: none;
            animation: achievementPop 0.5s ease;
        }

        @keyframes achievementPop {
            0% {
                transform: translate(-50%, -50%) scale(0);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.1);
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .achievement-unlock.visible {
            display: block;
        }

        .achievement-icon-big {
            font-size: 100px;
            margin-bottom: 20px;
        }

        .achievement-unlock h3 {
            font-family: 'Fredoka One', cursive;
            font-size: 32px;
            color: #2d3436;
            margin-bottom: 15px;
        }

        .achievement-unlock p {
            font-size: 20px;
            font-weight: 700;
            color: #636e72;
        }

        .stats-kids {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .stat-card-big {
            background: linear-gradient(135deg, #f8f9fa, white);
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            border: 4px solid #74b9ff;
            transition: all 0.3s;
        }

        .stat-card-big:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 50px rgba(0,0,0,0.2);
        }

        .stat-icon-big {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .stat-number-big {
            font-family: 'Fredoka One', cursive;
            font-size: 48px;
            color: #2d3436;
            margin-bottom: 10px;
        }

        .stat-label-big {
            font-size: 18px;
            font-weight: 700;
            color: #636e72;
        }

        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .achievement-card {
            background: linear-gradient(135deg, #dfe6e9, #b2bec3);
            padding: 30px;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 4px solid #636e72;
            transition: all 0.3s;
            opacity: 0.5;
        }

        .achievement-card.unlocked {
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
            border-color: #e17055;
            opacity: 1;
            animation: achievementGlow 2s infinite;
        }

        @keyframes achievementGlow {
            0%, 100% { box-shadow: 0 10px 30px rgba(253, 203, 110, 0.4); }
            50% { box-shadow: 0 10px 40px rgba(253, 203, 110, 0.8); }
        }

        .achievement-card:hover {
            transform: scale(1.05);
        }

        .achievement-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .ranking-container {
            background: white;
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.1);
            border: 4px solid #fdcb6e;
        }

        .ranking-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .ranking-header h2 {
            font-family: 'Fredoka One', cursive;
            font-size: 32px;
            color: #2d3436;
        }

        .ranking-filters {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #dfe6e9, #b2bec3);
            border: 3px solid #636e72;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 800;
            font-size: 16px;
            color: #2d3436;
            transition: all 0.3s;
            font-family: 'Nunito', sans-serif;
        }

        .filter-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
            color: white;
            border-color: #e17055;
        }

        .podium {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 20px;
            margin: 40px 0;
            min-height: 300px;
        }

        .podium-place {
            text-align: center;
            padding: 30px 20px;
            border-radius: 20px;
            border: 4px solid;
            min-width: 200px;
            transition: all 0.3s;
        }

        .podium-place:hover {
            transform: translateY(-10px);
        }

        .podium-place.first {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
            border-color: #d63031;
            order: 2;
            height: 300px;
        }

        .podium-place.second {
            background: linear-gradient(135deg, #dfe6e9, #b2bec3);
            border-color: #636e72;
            order: 1;
            height: 240px;
        }

        .podium-place.third {
            background: linear-gradient(135deg, #fab1a0, #e17055);
            border-color: #d63031;
            order: 3;
            height: 200px;
        }

        .podium-rank {
            font-family: 'Fredoka One', cursive;
            font-size: 48px;
            color: white;
            margin-bottom: 10px;
        }

        .podium-name {
            font-size: 20px;
            font-weight: 800;
            color: white;
            margin-bottom: 10px;
        }

        .podium-score {
            font-family: 'Fredoka One', cursive;
            font-size: 24px;
            color: white;
        }

        .ranking-table {
            margin-top: 30px;
        }

        .ranking-row {
            display: flex;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, white);
            border-radius: 20px;
            margin-bottom: 15px;
            border: 3px solid #dfe6e9;
            transition: all 0.3s;
        }

        .ranking-row:hover {
            transform: translateX(10px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .ranking-row.current-user {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            border-color: #0984e3;
        }

        .ranking-row.current-user * {
            color: white !important;
        }

        .ranking-position {
            font-family: 'Fredoka One', cursive;
            font-size: 28px;
            color: #2d3436;
            min-width: 60px;
            text-align: center;
        }

        .ranking-user {
            flex: 1;
            font-size: 20px;
            font-weight: 800;
            color: #2d3436;
            margin-left: 20px;
        }

        .ranking-stats {
            display: flex;
            gap: 30px;
            font-weight: 700;
            color: #636e72;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 25px;
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            z-index: 1500;
            font-weight: 800;
            border: 3px solid;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .connection-status.online {
            border-color: #00b894;
            color: #00b894;
        }

        .connection-status.offline {
            border-color: #636e72;
            color: #636e72;
        }

        .connection-status.connecting {
            border-color: #fdcb6e;
            color: #e17055;
        }

        .connection-status.error {
            border-color: #d63031;
            color: #d63031;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .settings-container {
            background: white;
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.1);
            border: 4px solid #74b9ff;
        }

        .settings-section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 3px solid #dfe6e9;
        }

        .settings-section:last-child {
            border-bottom: none;
        }

        .settings-section h3 {
            font-family: 'Fredoka One', cursive;
            font-size: 24px;
            color: #2d3436;
            margin-bottom: 20px;
        }

        .settings-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #dfe6e9, #b2bec3);
            border: 3px solid #636e72;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 800;
            font-size: 16px;
            color: #2d3436;
            margin: 10px 0;
            transition: all 0.3s;
            font-family: 'Nunito', sans-serif;
        }

        .settings-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .settings-btn.danger {
            background: linear-gradient(135deg, #ff7675, #d63031);
            color: white;
            border-color: #d63031;
        }

        .settings-btn.success {
            background: linear-gradient(135deg, #55efc4, #00b894);
            color: white;
            border-color: #00b894;
        }

        .timer-display {
            font-family: 'Fredoka One', cursive;
            font-size: 28px;
            color: #2d3436;
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
            border-radius: 20px;
            border: 4px solid #e17055;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                padding: 15px;
                flex-direction: column;
                gap: 15px;
            }

            .user-info {
                flex-direction: column;
                text-align: center;
                width: 100%;
            }

            .avatar {
                width: 60px;
                height: 60px;
                font-size: 28px;
            }

            .stats {
                width: 100%;
                justify-content: space-around;
            }

            .stat-card {
                min-width: 80px;
                padding: 12px;
            }

            .stat-card h3 {
                font-size: 20px;
            }

            .stat-card p {
                font-size: 12px;
            }

            .tab-navigation {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .tab-navigation::-webkit-scrollbar {
                display: none;
            }

            .nav-tab {
                min-width: 120px;
                padding: 12px 15px;
                font-size: 14px;
                white-space: nowrap;
            }

            .calendar-grid {
                grid-template-columns: repeat(7, 1fr);
                gap: 6px;
            }

            .day-cell {
                min-height: 60px;
                padding: 5px;
            }

            .day-number {
                font-size: 14px;
            }

            .day-status {
                font-size: 18px;
            }

            .exercise-content {
                padding: 15px;
            }

            .exercise-modal {
                padding: 15px;
            }

            .option-btn {
                padding: 12px;
                font-size: 15px;
            }

            .podium {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }

            .podium-place {
                width: 100%;
                max-width: 300px;
                height: auto !important;
            }

            .podium-place.first {
                order: 1;
            }

            .podium-place.second {
                order: 2;
            }

            .podium-place.third {
                order: 3;
            }

            .ranking-table {
                font-size: 14px;
            }

            .ranking-row td {
                padding: 10px 5px;
                font-size: 13px;
            }

            .achievement-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .calendar-header h2 {
                font-size: 24px;
            }

            .login-card {
                padding: 30px 20px;
                margin: 10px;
            }

            .login-card h1 {
                font-size: 2em;
            }
        }

        /* Media query espec√≠fica para pantallas grandes (S24 Ultra y similares) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .calendar-grid {
                gap: 10px;
            }

            .day-cell {
                min-height: 80px;
            }

            .nav-tab {
                padding: 15px 20px;
                font-size: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">
        <div class="status-dot"></div>
        <span id="statusText">Desconectado</span>
    </div>

    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <h1>üéÆ Academia Pokemon</h1>
            <p>¬°Bienvenido, S√∫per Entrenador! üöÄ</p>
            <input type="text" id="usernameInput" placeholder="Escribe tu nombre de entrenador">
            <button onclick="login()">¬°Comenzar Aventura! üåü</button>
        </div>
    </div>

    <div class="main-app" id="mainApp">
        <div class="container">
            <div class="header">
                <div class="user-info">
                    <div class="avatar" id="userAvatar">üéÆ</div>
                    <div>
                        <h2 id="userName">S√∫per Entrenador</h2>
                        <p id="userLevel">Nivel 1 - Novato Genial</p>
                    </div>
                </div>
                <div class="stats">
                    <div class="stat-card">
                        <h3 id="totalPoints">0</h3>
                        <p>‚≠ê Puntos</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="streak">0</h3>
                        <p>üî• Racha</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="achievements">0</h3>
                        <p>üèÜ Logros</p>
                    </div>
                </div>
            </div>

            <div class="tab-navigation">
                <div class="nav-tab active" data-tab="calendar" onclick="showTab('calendar')">üìÖ Calendario</div>
                <div class="nav-tab" data-tab="stats" onclick="showTab('stats')">üìä Estad√≠sticas</div>
                <div class="nav-tab" data-tab="achievements" onclick="showTab('achievements')">üèÜ Logros</div>
                <div class="nav-tab" data-tab="ranking" onclick="showTab('ranking')">ü•á Ranking</div>
                <div class="nav-tab" data-tab="settings" onclick="showTab('settings')">‚öôÔ∏è Ajustes</div>
            </div>

            <div id="calendarTab" class="tab-content active">
                <div class="calendar-wrapper">
                    <div class="calendar-header">
                        <h2>üóìÔ∏è Tu Calendario de Aventuras</h2>
                        <p style="font-size: 18px; font-weight: 600; color: #636e72;">¬°30 minutos geniales cada d√≠a! üåü</p>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 20px; border-radius: 20px; margin-bottom: 25px; border: 3px solid #2196f3;">
                        <h4 style="font-family: 'Fredoka One', cursive; font-size: 18px; color: #0d47a1; margin-bottom: 15px; text-align: center;">üìã Leyenda del Calendario</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-weight: 700; font-size: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 24px;">üéØ</span>
                                <span style="color: #1565c0;">Hoy - ¬°A jugar!</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 24px;">üìù</span>
                                <span style="color: #1565c0;">Recuperar d√≠a perdido</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 24px;">‚úÖ</span>
                                <span style="color: #1565c0;">¬°Completado!</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 24px;">üîí</span>
                                <span style="color: #1565c0;">Bloqueado (futuro)</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="weeksContainer"></div>
                </div>
            </div>

            <div id="statsTab" class="tab-content">
                <div class="settings-container">
                    <div class="calendar-header">
                        <h2>üìä Mis Estad√≠sticas S√∫per Geniales</h2>
                    </div>
                    <div id="statsContent"></div>
                </div>
            </div>

            <div id="achievementsTab" class="tab-content">
                <div class="settings-container">
                    <div class="calendar-header">
                        <h2>üèÜ Mis Logros Incre√≠bles</h2>
                    </div>
                    <div id="achievementGrid" class="achievement-grid"></div>
                </div>
            </div>

            <div id="rankingTab" class="tab-content">
                <div class="ranking-container">
                    <div class="ranking-header">
                        <h2>ü•á Ranking de S√∫per Campeones</h2>
                    </div>
                    <div class="ranking-filters">
                        <button class="filter-btn active" onclick="setRankingFilter('all')">üåü Todos</button>
                        <button class="filter-btn" onclick="setRankingFilter('week')">üìÖ Esta Semana</button>
                        <button class="filter-btn" onclick="setRankingFilter('month')">üìÜ Este Mes</button>
                    </div>
                    <div id="podiumContainer" class="podium"></div>
                    <div id="rankingTableContainer" class="ranking-table"></div>
                </div>
            </div>

            <div id="settingsTab" class="tab-content">
                <div class="settings-container">
                    <div class="calendar-header">
                        <h2>‚öôÔ∏è Configuraci√≥n</h2>
                    </div>
                    
                    <div class="settings-section">
                        <h3>üîå Conexi√≥n</h3>
                        <button class="settings-btn success" onclick="testConnection()">üîÑ Probar Conexi√≥n</button>
                    </div>
                    
                    <div class="settings-section">
                        <h3>üíæ Datos</h3>
                        <button class="settings-btn" onclick="exportData()">üì• Exportar Mis Datos</button>
                        <button class="settings-btn danger" onclick="resetProgress()">üîÑ Reiniciar Progreso</button>
                    </div>
                    
                    <div class="settings-section">
                        <h3>‚ö†Ô∏è Zona Peligrosa</h3>
                        <button class="settings-btn danger" onclick="deleteUser()">üóëÔ∏è Eliminar Usuario Completo</button>
                        <p style="font-size: 14px; color: #d63031; font-weight: 600; margin-top: 10px;">‚ö†Ô∏è Esta acci√≥n borrar√° PERMANENTEMENTE tu usuario y todos tus datos del servidor.</p>
                    </div>
                    
                    <div class="settings-section">
                        <h3>‚ÑπÔ∏è Informaci√≥n</h3>
                        <p style="font-weight: 600; color: #636e72; margin: 10px 0;">Versi√≥n: 4.0 Final - ¬°Con Textos Largos! üöÄ</p>
                        <p style="font-weight: 600; color: #636e72; margin: 10px 0;">Usuario actual: <span id="currentUserDisplay"></span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="exercise-modal" id="exerciseModal">
        <div class="exercise-content">
            <button class="close-modal" onclick="closeExerciseModal()">‚úï</button>
            <div class="exercise-header">
                <h3 id="exerciseTitle">Ejercicios S√∫per Geniales</h3>
                <div id="subjectBadges"></div>
                <div class="timer-display" id="timerDisplay">‚è±Ô∏è Tiempo: 30:00</div>
            </div>
            
            <div class="progress-indicator" id="progressIndicator"></div>
            
            <div id="exerciseContainer"></div>
            
            <div class="hint-box" id="hintBox">
                <div style="font-size: 24px; margin-bottom: 10px;">üí° Pista Genial</div>
                <div class="hint-text" id="hintText"></div>
            </div>
            
            <div class="feedback-box" id="feedbackBox">
                <div id="feedbackText"></div>
            </div>

            <div class="explanation-box" id="explanationBox">
                <h4>üìö ¬øPor qu√© es as√≠?</h4>
                <div id="explanationText"></div>
            </div>
            
            <div class="exercise-buttons">
                <button class="exercise-btn secondary" id="hintBtn" onclick="showHint()">üí° Pista</button>
                <button class="exercise-btn primary" id="checkBtn" onclick="checkAnswer()">‚úì Comprobar</button>
                <button class="exercise-btn success" id="nextBtn" onclick="nextExercise()" style="display: none;">‚ûú Siguiente</button>
            </div>
        </div>
    </div>

    <div class="achievement-unlock" id="achievementUnlock">
        <div class="achievement-icon-big" id="unlockedIcon">üèÜ</div>
        <h3 id="unlockedName">¬°S√∫per Logro!</h3>
        <p id="unlockedDescription">¬°Has desbloqueado algo genial!</p>
        <button class="exercise-btn success" onclick="closeAchievementUnlock()" style="margin-top: 30px; width: 100%;">¬°Genial! üéâ</button>
    </div>

    <script>
        const JSONBIN_CONFIG = {
            binId: '68ee144343b1c97be96704f9',
            masterKey: '$2a$10$byEkgCiPtr6uA9j.sw5Uiuld00jGPRMT1Rn9TlhHYbPe3CFfaEu6G',
            apiUrl: 'https://api.jsonbin.io/v3'
        };

        let appState = {
            currentUser: null,
            userData: null,
            allUsersData: {},
            currentDay: null,
            currentExerciseIndex: 0,
            currentExercises: [],
            selectedAnswer: null,
            currentRankingFilter: 'all',
            sessionStartTime: null,
            timerInterval: null,
            timeRemaining: 1800
        };

        // BANCO DE EJERCICIOS CON TEXTOS LARGOS DE COMPRENSI√ìN LECTORA
        const exerciseBank = {
            math: [
                {
                    instruction: "üéÆ Pikachu necesita tu ayuda con las matem√°ticas. Lee con atenci√≥n y calcula:",
                    question: "Pikachu ha derrotado a 234 Pokemon en batallas. Charizard ha derrotado el doble que Pikachu. ¬øCu√°ntos Pokemon ha derrotado Charizard?",
                    options: ["468 Pokemon", "334 Pokemon", "464 Pokemon", "234 Pokemon"],
                    correct: 0,
                    hint: "El doble significa multiplicar por 2. Puedes sumar 234 + 234 para encontrar la respuesta.",
                    explanation: "Cuando decimos 'el doble', significa multiplicar por 2. Entonces: 234 √ó 2 = 468. Tambi√©n puedes pensarlo como sumar el n√∫mero dos veces: 234 + 234 = 468. ¬°Charizard es s√∫per fuerte! üî•"
                },
                {
                    instruction: "‚öΩ ¬°Problema de f√∫tbol! Vamos a resolver este ejercicio sobre el Real Madrid:",
                    question: "En el Bernab√©u caben 81.044 personas. Si ya hay 56.789 espectadores viendo el partido, ¬øcu√°ntas personas m√°s pueden entrar?",
                    options: ["24.255 personas", "25.255 personas", "24.155 personas", "23.255 personas"],
                    correct: 0,
                    hint: "Tienes que restar: lo que cabe menos lo que ya hay. Empieza por las unidades y no olvides pedir prestado cuando sea necesario.",
                    explanation: "Para saber cu√°ntas personas m√°s pueden entrar, restamos: 81.044 - 56.789 = 24.255. Es como si el estadio fuera una caja que puede guardar 81.044 caramelos, y ya tiene 56.789, entonces caben 24.255 m√°s. ‚öΩ‚ú®"
                },
                {
                    instruction: "üéÆ Eren necesita calcular recursos para proteger la muralla. ¬°Ay√∫dalo!",
                    question: "Los Titanes atacan en grupos de 8. Si Eren cuenta 96 Titanes acerc√°ndose, ¬øcu√°ntos grupos son?",
                    options: ["12 grupos", "11 grupos", "13 grupos", "10 grupos"],
                    correct: 0,
                    hint: "Divide el total de Titanes entre el tama√±o de cada grupo. Puedes usar la tabla del 8.",
                    explanation: "Para saber cu√°ntos grupos hay, dividimos: 96 √∑ 8 = 12 grupos. La divisi√≥n nos ayuda a repartir cosas en partes iguales. ¬°Es como separar 96 soldados en escuadrones de 8! ‚öîÔ∏è"
                },
                {
                    instruction: "‚öΩ ¬°Problema con las medallas del Barcelona!",
                    question: "El Bar√ßa tiene 3 cajas de medallas. Cada caja contiene 25 medallas. ¬øCu√°ntas medallas tienen en total?",
                    options: ["75 medallas", "70 medallas", "80 medallas", "65 medallas"],
                    correct: 0,
                    hint: "Multiplica el n√∫mero de cajas por las medallas en cada caja. 25 √ó 3 = ?",
                    explanation: "Multiplicamos: 3 cajas √ó 25 medallas = 75 medallas. La multiplicaci√≥n es una suma r√°pida: 25 + 25 + 25 = 75. ¬°El Bar√ßa tiene muchas victorias! üèÜ"
                },
                {
                    instruction: "üéÆ ¬°Ash est√° contando sus Pokeballs! Vamos a ayudarlo:",
                    question: "Ash tiene 1/4 de sus Pokeballs llenas con Pokemon de tipo Agua. Si tiene 20 Pokeballs, ¬øcu√°ntas tienen Pokemon de Agua?",
                    options: ["5 Pokeballs", "10 Pokeballs", "4 Pokeballs", "8 Pokeballs"],
                    correct: 0,
                    hint: "1/4 significa dividir en 4 partes iguales y tomar 1. Divide 20 √∑ 4.",
                    explanation: "Una fracci√≥n 1/4 significa dividir algo en 4 partes iguales. Si tenemos 20 Pokeballs y las dividimos en 4 grupos: 20 √∑ 4 = 5. Cada grupo tiene 5 Pokeballs. ¬°Splash! üíß"
                },
                {
                    instruction: "‚öΩ Cristiano Ronaldo est√° entrenando. ¬°Necesita tu ayuda para contar!",
                    question: "Cristiano ha marcado 567 goles en su carrera. Luego marca 345 goles m√°s en las siguientes temporadas. ¬øCu√°ntos goles lleva en total?",
                    options: ["912 goles", "902 goles", "812 goles", "922 goles"],
                    correct: 0,
                    hint: "Suma los goles: 567 + 345. Recuerda ir sumando de derecha a izquierda: unidades, decenas, centenas.",
                    explanation: "Sumamos: 567 + 345 = 912 goles. Primero sumamos las unidades (7+5=12, ponemos 2 y llevamos 1), luego las decenas (6+4+1=11, ponemos 1 y llevamos 1), finalmente las centenas (5+3+1=9). ¬°Cristiano es una leyenda! ‚öΩüëë"
                }
            ],
            reading: [
                {
                    instruction: "üìñ Lee este texto COMPLETO sobre la aventura de Pikachu. T√≥mate tu tiempo, luego responde las preguntas:",
                    passageTitle: "La Gran Aventura de Pikachu en el Bosque Misterioso",
                    passage: "Era un d√≠a soleado en Ciudad Paleta cuando Pikachu decidi√≥ explorar el Bosque Verde. Ash, su entrenador, le hab√≠a dado permiso para ir, pero le advirti√≥: 'Ten cuidado, Pikachu. En el bosque viven Pokemon salvajes muy poderosos.'\n\nPikachu camin√≥ por el sendero principal durante una hora hasta que escuch√≥ un ruido extra√±o detr√°s de unos arbustos. Sus mejillas el√©ctricas comenzaron a brillar, listo para defenderse. De repente, apareci√≥ un peque√±o Caterpie asustado. 'Pi-pika?' pregunt√≥ Pikachu amablemente.\n\nEl Caterpie explic√≥ que se hab√≠a perdido buscando hojas de mora para comer. Pikachu, siendo muy bondadoso, decidi√≥ ayudarlo. Juntos caminaron durante dos horas hasta encontrar un √°rbol enorme lleno de deliciosas hojas verdes.\n\nMientras Caterpie com√≠a feliz, Pikachu escuch√≥ un grito lejano. ¬°Era Ash! Estaba busc√°ndolo porque ya era hora de volver a casa. Pikachu se despidi√≥ de su nuevo amigo con un 'Pika-chu!' alegre y corri√≥ hacia la voz de Ash.\n\nCuando lleg√≥, Ash lo abraz√≥ fuerte. 'Me preocup√© mucho, Pikachu. Pero veo que has hecho un buen amigo.' Pikachu asinti√≥ orgulloso. Esa noche, mientras descansaba en su Pokeball, Pikachu so√±√≥ con m√°s aventuras en el bosque.",
                    question: "¬øCu√°nto tiempo camin√≥ Pikachu en total durante su aventura? (cuenta el tiempo del inicio y el tiempo que ayud√≥ a Caterpie)",
                    options: ["3 horas en total", "1 hora en total", "2 horas en total", "4 horas en total"],
                    correct: 0,
                    hint: "Lee de nuevo el texto. Pikachu camin√≥ 1 hora al principio, y luego 2 horas m√°s ayudando a Caterpie. ¬øCu√°nto es 1 + 2?",
                    explanation: "Pikachu camin√≥ 1 hora al principio por el sendero principal, y luego camin√≥ 2 horas m√°s ayudando a Caterpie a encontrar el √°rbol. En total: 1 + 2 = 3 horas. ¬°Pikachu es muy generoso con su tiempo! ‚ö°üïê"
                },
                {
                    instruction: "üìñ Lee este texto LARGO sobre el Real Madrid. Presta mucha atenci√≥n a todos los detalles:",
                    passageTitle: "El Real Madrid: Historia de un Gigante del F√∫tbol",
                    passage: "El Real Madrid fue fundado en el a√±o 1902, hace m√°s de 120 a√±os. Al principio se llamaba simplemente 'Madrid Football Club', pero en 1920 el Rey Alfonso XIII le dio el t√≠tulo de 'Real', que significa 'del Rey'. Desde ese momento, el escudo del equipo lleva una corona dorada en la parte superior.\n\nEl estadio del Real Madrid se llama Santiago Bernab√©u, en honor a un presidente del club muy importante que lo construy√≥ en 1947. Tiene capacidad para m√°s de 81.000 espectadores y es uno de los estadios m√°s famosos del mundo. Cuando hay un partido importante, se llena completamente y los aficionados cantan durante los 90 minutos que dura el partido.\n\nLos colores del Real Madrid son el blanco y el dorado. Por eso los llaman 'Los Blancos' o 'Los Merengues'. El equipo ha ganado 14 Champions League, que es el torneo m√°s importante de Europa. Ning√∫n otro equipo ha ganado tantas.\n\nAlgunos de los jugadores m√°s famosos que han jugado en el Real Madrid son: Alfredo Di St√©fano en los a√±os 50, quien marc√≥ 308 goles; Cristiano Ronaldo entre 2009 y 2018, quien marc√≥ incre√≠bles 450 goles; y actualmente juegan estrellas como Vin√≠cius Jr. y Jude Bellingham.\n\nEl Real Madrid tiene una rivalidad hist√≥rica con el FC Barcelona. Cuando juegan entre ellos, al partido se le llama 'El Cl√°sico' y es visto por m√°s de 500 millones de personas en todo el mundo. ¬°Es el partido m√°s visto del planeta!",
                    question: "Seg√∫n el texto, ¬øcu√°ntos goles marc√≥ Cristiano Ronaldo en el Real Madrid?",
                    options: ["450 goles", "308 goles", "500 goles", "81 goles"],
                    correct: 0,
                    hint: "Busca en el cuarto p√°rrafo donde habla de Cristiano Ronaldo. Lee con cuidado el n√∫mero exacto que menciona.",
                    explanation: "El texto dice claramente: 'Cristiano Ronaldo entre 2009 y 2018, quien marc√≥ incre√≠bles 450 goles'. Los 308 goles fueron de Di St√©fano. Es importante leer con atenci√≥n para no confundir los n√∫meros. ‚öΩüëë"
                },
                {
                    instruction: "üìñ Lee esta HISTORIA LARGA sobre Ataque a los Titanes. Lee todo con mucha atenci√≥n:",
                    passageTitle: "El D√≠a que Cambi√≥ Todo: La Ca√≠da del Muro Mar√≠a",
                    passage: "Eren Yeager ten√≠a 10 a√±os cuando viv√≠a tranquilamente en el distrito de Shiganshina, protegido por tres enormes murallas: Mar√≠a (la exterior), Rose (la del medio) y Sina (la interior). Estas murallas de 50 metros de altura hab√≠an protegido a la humanidad de los Titanes durante 100 a√±os.\n\nEren viv√≠a con su padre Grisha, quien era m√©dico, su madre Carla, y su hermana adoptiva Mikasa. Aunque la vida era segura, Eren so√±aba con salir de las murallas y explorar el mundo exterior. Su mejor amigo Armin compart√≠a ese sue√±o y le mostraba libros secretos sobre el oc√©ano y las monta√±as que exist√≠an m√°s all√°.\n\nUn d√≠a terrible, apareci√≥ el Tit√°n Colosal, un tit√°n de 60 metros de altura que era m√°s alto que las propias murallas. Con una patada, destruy√≥ la puerta del Muro Mar√≠a. Los titanes entraron a la ciudad y comenz√≥ una masacre horrible. Eren vio con sus propios ojos c√≥mo un tit√°n atacaba a su madre. No pudo hacer nada para salvarla.\n\nEsa tragedia cambi√≥ a Eren para siempre. Jur√≥ vengarse de todos los Titanes y unirse al Cuerpo de Exploraci√≥n, el grupo de soldados m√°s valientes que sal√≠an de las murallas para luchar. Mikasa y Armin decidieron acompa√±arlo en su misi√≥n.\n\nDespu√©s de tres a√±os de entrenamiento duro, Eren, Mikasa y Armin se graduaron. Eren qued√≥ en el puesto n√∫mero 5 de su promoci√≥n, Mikasa fue la n√∫mero 1 por ser incre√≠blemente fuerte, y Armin, aunque no era muy fuerte f√≠sicamente, era el m√°s inteligente de todos.\n\nJuntos comenzaron su nueva vida como soldados, listos para enfrentarse a los Titanes y descubrir los secretos que el mundo escond√≠a detr√°s de las murallas.",
                    question: "¬øEn qu√© puesto qued√≥ Eren en su graduaci√≥n del entrenamiento militar?",
                    options: ["Puesto n√∫mero 5", "Puesto n√∫mero 1", "Puesto n√∫mero 10", "Puesto n√∫mero 3"],
                    correct: 0,
                    hint: "Busca en el quinto p√°rrafo (el pen√∫ltimo) donde habla sobre la graduaci√≥n. Menciona el puesto de Eren, Mikasa y Armin.",
                    explanation: "El texto dice: 'Eren qued√≥ en el puesto n√∫mero 5 de su promoci√≥n, Mikasa fue la n√∫mero 1 por ser incre√≠blemente fuerte, y Armin, aunque no era muy fuerte f√≠sicamente, era el m√°s inteligente de todos.' ¬°Mikasa fue la mejor! ‚öîÔ∏è"
                },
                {
                    instruction: "üìù Gram√°tica Pokemon. Vamos a identificar el VERBO:",
                    question: "En la frase: 'Los Pokemon luchan valientemente en el gimnasio' - ¬øCu√°l es el VERBO?",
                    options: ["luchan", "Pokemon", "gimnasio", "valientemente"],
                    correct: 0,
                    hint: "El verbo es la palabra que indica la ACCI√ìN que realizan los Pokemon. ¬øQu√© est√°n haciendo?",
                    explanation: "El verbo es 'luchan' porque indica la acci√≥n que realizan los Pokemon. Los verbos expresan acciones (correr, saltar, luchar), estados (ser, estar) o procesos (crecer, aprender). ¬°Son s√∫per importantes! üí™"
                },
                {
                    instruction: "üìù ¬°Ortograf√≠a futbolera! elige la palabra correcta:",
                    question: "¬øC√≥mo se escribe correctamente?",
                    options: ["Messi jug√≥ un partido incre√≠ble", "Mesi jugo un partido increible", "Messi jugo un partido incre√≠ble", "Mesi jug√≥ un partido increible"],
                    correct: 0,
                    hint: "Recuerda: los nombres propios van con may√∫scula, 'jug√≥' lleva tilde porque es pasado, e 'incre√≠ble' tambi√©n lleva tilde.",
                    explanation: "La forma correcta es 'Messi jug√≥ un partido incre√≠ble'. Los nombres propios van con may√∫scula. 'Jug√≥' lleva tilde porque es tiempo pasado. 'Incre√≠ble' es una palabra esdr√∫jula (acento en la antepen√∫ltima s√≠laba) y todas llevan tilde. ‚öΩ‚úçÔ∏è"
                },
                {
                    instruction: "üìñ Comprensi√≥n de sin√≥nimos con Titanes:",
                    question: "En la frase 'Los Titanes son ENORMES y aterradores', ¬øqu√© palabra es sin√≥nimo de ENORMES?",
                    options: ["Gigantes", "Peque√±os", "R√°pidos", "Feos"],
                    correct: 0,
                    hint: "Un sin√≥nimo es una palabra que significa lo mismo o casi lo mismo. Piensa qu√© otra palabra significa 'muy grande'.",
                    explanation: "Gigantes es sin√≥nimo de enormes porque ambas palabras significan 'muy grande'. Los sin√≥nimos nos ayudan a no repetir palabras y hacer nuestros textos m√°s ricos. Otros sin√≥nimos: inmensos, colosales. üèîÔ∏è"
                }
            ],
            science: [
                {
                    instruction: "üî¨ ¬°Ciencia Pokemon! Vamos a aprender sobre seres vivos:",
                    question: "Pikachu, Squirtle y Charizard son seres vivos. ¬øQu√© necesitan TODOS los seres vivos para sobrevivir?",
                    options: ["Agua, alimento y aire", "Solo Pokeballs", "Solo batallas", "Solo entrenadores"],
                    correct: 0,
                    hint: "Piensa en lo que necesitas T√ö para vivir. Los Pokemon, como todos los seres vivos, necesitan lo mismo.",
                    explanation: "TODOS los seres vivos necesitan agua, alimento y aire para sobrevivir. Los Pokemon, los humanos, las plantas y los animales comparten estas necesidades b√°sicas. Sin estas tres cosas, ning√∫n ser vivo puede existir. ¬°Es la regla de oro de la vida! üíßüçéüí®"
                },
                {
                    instruction: "‚öΩ Ciencia en el f√∫tbol. ¬øQu√© pasa cuando pateamos el bal√≥n?",
                    question: "Cuando Messi patea un bal√≥n de f√∫tbol, este sale volando. ¬øQu√© tipo de energ√≠a usa Messi?",
                    options: ["Energ√≠a de movimiento (cin√©tica)", "Energ√≠a el√©ctrica", "Energ√≠a solar", "Energ√≠a m√°gica"],
                    correct: 0,
                    hint: "Piensa en c√≥mo se mueve tu pierna cuando pateas. Ese movimiento es energ√≠a.",
                    explanation: "Messi usa energ√≠a cin√©tica, que es la energ√≠a del movimiento. Cuando mueve su pierna y patea, transfiere esa energ√≠a al bal√≥n, haci√©ndolo volar. ¬°La f√≠sica est√° en todos lados, hasta en el f√∫tbol! ‚öΩüí®"
                },
                {
                    instruction: "üåç Los Titanes y la naturaleza. Aprendamos sobre el cuerpo:",
                    question: "Los Titanes tienen cuerpos enormes pero no tienen √≥rganos como nosotros. ¬øQu√© √≥rgano bombea la sangre en el cuerpo humano?",
                    options: ["El coraz√≥n", "Los pulmones", "El est√≥mago", "El cerebro"],
                    correct: 0,
                    hint: "Este √≥rgano est√° en el pecho y late constantemente. Lo sientes cuando corres.",
                    explanation: "El coraz√≥n es el √≥rgano que bombea la sangre a todo el cuerpo. Late aproximadamente 100.000 veces al d√≠a, enviando sangre con ox√≠geno y nutrientes a todas las c√©lulas. ¬°Es como una s√∫per bomba que nunca descansa! ‚ù§Ô∏è"
                },
                {
                    instruction: "üî¨ El agua Pokemon. ¬°Experimento con estados de la materia!",
                    question: "Squirtle lanza agua l√≠quida. Si hace mucho fr√≠o, ¬øen qu√© se convierte el agua?",
                    options: ["En hielo (s√≥lido)", "En vapor (gas)", "Sigue l√≠quida", "Desaparece"],
                    correct: 0,
                    hint: "Piensa en lo que pasa cuando metes agua en el congelador.",
                    explanation: "Cuando el agua l√≠quida se enfr√≠a mucho (a 0¬∞C o menos), se convierte en hielo, que es agua en estado s√≥lido. Este cambio se llama 'solidificaci√≥n' o 'congelaci√≥n'. Los tres estados del agua son: hielo (s√≥lido), agua (l√≠quido) y vapor (gas). ‚ùÑÔ∏èüíß‚òÅÔ∏è"
                },
                {
                    instruction: "üåç Sistema Solar futbolero. ¬°Vamos a aprender sobre planetas!",
                    question: "Si pudi√©ramos jugar f√∫tbol en todos los planetas, ¬øcu√°l est√° m√°s cerca del Sol y ser√≠a el m√°s caliente?",
                    options: ["Mercurio", "Venus", "Tierra", "Marte"],
                    correct: 0,
                    hint: "El planeta m√°s cercano al Sol empieza con M. Piensa en el orden: Mercurio, Venus, Tierra, Marte...",
                    explanation: "Mercurio es el planeta m√°s cercano al Sol. Aunque Venus es m√°s caliente (por su atm√≥sfera), Mercurio est√° en primer lugar en distancia. El orden de los planetas es: Mercurio, Venus, Tierra, Marte, J√∫piter, Saturno, Urano y Neptuno. ¬°Un truco para recordar: Mi Vieja T√≠a Mar√≠a Jam√°s Supo Una Noticia! ‚òÄÔ∏èü™ê"
                },
                {
                    instruction: "üî¨ Las plantas y los Titanes. ¬°Aprendamos bot√°nica!",
                    question: "Fuera de las murallas crecen √°rboles enormes. ¬øQu√© partes tiene un √°rbol?",
                    options: ["Ra√≠z, tallo (tronco), hojas y puede tener flores o frutos", "Solo tronco y hojas", "Solo ra√≠z", "Solo hojas y frutos"],
                    correct: 0,
                    hint: "Piensa en un √°rbol completo: lo que est√° bajo tierra, lo que sube, lo que tiene arriba...",
                    explanation: "Las plantas tienen varias partes importantes: La RA√çZ (bajo tierra, absorbe agua), el TALLO o TRONCO (sostiene la planta), las HOJAS (hacen fotos√≠ntesis para crear alimento), y pueden tener FLORES (para reproducirse) y FRUTOS (con semillas). ¬°Cada parte tiene su funci√≥n especial! üå≥üå∏"
                }
            ],
            social: [
                {
                    instruction: "üåç Geograf√≠a Pokemon. ¬øD√≥nde viven los Pokemon?",
                    question: "La regi√≥n de Kanto en Pokemon est√° inspirada en Jap√≥n. ¬øEn qu√© continente est√° Jap√≥n?",
                    options: ["Asia", "Europa", "Am√©rica", "√Åfrica"],
                    correct: 0,
                    hint: "Jap√≥n es un pa√≠s de islas en el Este del mundo, cerca de China y Corea.",
                    explanation: "Jap√≥n est√° en Asia, el continente m√°s grande del mundo. Asia tiene pa√≠ses como China, India, Corea, Tailandia y muchos m√°s. Jap√≥n es un archipi√©lago (conjunto de islas) en el oc√©ano Pac√≠fico. ¬°Por eso hay tantos Pokemon de tipo Agua! üóæüåè"
                },
                {
                    instruction: "‚öΩ Geograf√≠a futbolera. ¬°Capitales de Espa√±a!",
                    question: "El Real Madrid juega en Madrid. ¬øMadrid es la capital de...?",
                    options: ["Espa√±a", "Catalu√±a", "Andaluc√≠a", "Madrid no es capital"],
                    correct: 0,
                    hint: "Madrid es la capital de TODO el pa√≠s de Espa√±a.",
                    explanation: "Madrid es la capital de Espa√±a, el pa√≠s completo. Una capital es la ciudad m√°s importante de un pa√≠s o regi√≥n, donde normalmente est√° el gobierno. Espa√±a tiene 17 comunidades aut√≥nomas, y Madrid es tanto una comunidad como la capital del pa√≠s. üá™üá∏üëë"
                },
                {
                    instruction: "üåç Historia de los Titanes. ¬°Aprendamos sobre murallas y defensa!",
                    question: "En la Edad Media tambi√©n constru√≠an murallas como en Ataque a los Titanes. ¬øPara qu√© serv√≠an?",
                    options: ["Para proteger ciudades de ataques enemigos", "Para decorar", "Para jugar", "Para guardar comida"],
                    correct: 0,
                    hint: "Piensa por qu√© construir√≠an muros enormes alrededor de las ciudades. ¬øDe qu√© se quer√≠an proteger?",
                    explanation: "Las murallas serv√≠an para PROTEGER las ciudades de enemigos. En la Edad Media (hace cientos de a√±os), las ciudades constru√≠an murallas de piedra para defenderse de invasores. Los castillos tambi√©n ten√≠an murallas. ¬°Igual que en Ataque a los Titanes, pero contra otros humanos en lugar de Titanes! üè∞‚öîÔ∏è"
                },
                {
                    instruction: "üó∫Ô∏è Los puntos cardinales en el mundo Pokemon:",
                    question: "Si Ash est√° mirando hacia donde sale el sol (Este), y gira a su derecha, ¬øhacia d√≥nde mira ahora?",
                    options: ["Sur", "Norte", "Oeste", "Este"],
                    correct: 0,
                    hint: "Cuando miras al Este, el Norte est√° a tu izquierda y el Sur a tu derecha.",
                    explanation: "Si miras al Este y giras a la derecha, miras al SUR. Los puntos cardinales son: Norte (arriba), Sur (abajo), Este (derecha, donde sale el sol) y Oeste (izquierda, donde se pone el sol). Truco para recordar: Nunca Se√±ores Olviden Este. üß≠‚òÄÔ∏è"
                },
                {
                    instruction: "‚öΩ Convivencia y respeto en el deporte:",
                    question: "En un partido de f√∫tbol, tu equipo pierde 0-5. ¬øQu√© es lo correcto hacer?",
                    options: ["Felicitar al otro equipo y aprender de los errores", "Enfadarse y no hablar con nadie", "Decir que hicieron trampa", "Dejar de jugar al f√∫tbol"],
                    correct: 0,
                    hint: "Piensa en c√≥mo te gustar√≠a que te trataran si t√∫ ganaras. El respeto es importante.",
                    explanation: "Lo correcto es felicitar al otro equipo y aprender de los errores. Esto se llama DEPORTIVIDAD. Ganar y perder son parte de los juegos y de la vida. Lo importante es esforzarse, mejorar y respetar a los dem√°s. ¬°Los grandes campeones tambi√©n pierden a veces! ü§ù‚öΩ"
                },
                {
                    instruction: "üåç Servicios de la comunidad con Pokemon:",
                    question: "Si Pikachu se enferma, Ash lo lleva al Centro Pokemon. En nuestra ciudad, ¬øa d√≥nde vamos cuando estamos enfermos?",
                    options: ["Al hospital o centro de salud", "Al ayuntamiento", "A la escuela", "Al parque"],
                    correct: 0,
                    hint: "Piensa en el lugar donde trabajan m√©dicos y enfermeras para curar a las personas.",
                    explanation: "Vamos al HOSPITAL o CENTRO DE SALUD cuando estamos enfermos. Es un servicio p√∫blico muy importante. All√≠ trabajan m√©dicos, enfermeras y otros profesionales para cuidar nuestra salud. ¬°Es como el Centro Pokemon pero para humanos! üè•üë®‚Äç‚öïÔ∏è"
                }
            ]
        };

        const achievements = [
            { id: 'first_day', name: '¬°Primer D√≠a Genial!', description: 'Completa tu primer d√≠a de ejercicios', icon: 'üåü' },
            { id: 'week_warrior', name: 'Guerrero de la Semana', description: 'Completa una semana completa', icon: '‚öîÔ∏è' },
            { id: 'perfect_score', name: 'Perfecci√≥n Total', description: 'Consigue 100% en todos los ejercicios de un d√≠a', icon: 'üíØ' },
            { id: 'streak_5', name: 'Racha de Fuego', description: 'Mant√©n una racha de 5 d√≠as', icon: 'üî•' },
            { id: 'streak_10', name: 'Imparable', description: 'Mant√©n una racha de 10 d√≠as', icon: '‚ö°' },
            { id: 'math_master', name: 'Maestro de Mates', description: 'Completa 20 ejercicios de matem√°ticas', icon: 'üßÆ' },
            { id: 'reading_pro', name: 'S√∫per Lector', description: 'Completa 20 ejercicios de lectura', icon: 'üìö' },
            { id: 'science_genius', name: 'Genio Cient√≠fico', description: 'Completa 20 ejercicios de ciencias', icon: 'üî¨' },
            { id: 'social_expert', name: 'Experto Social', description: 'Completa 20 ejercicios de sociales', icon: 'üåç' },
            { id: 'century_club', name: 'Club del Centenar', description: 'Completa 100 ejercicios en total', icon: 'üí™' },
            { id: 'speed_demon', name: 'Rayo Veloz', description: 'Completa un d√≠a en menos de 20 minutos', icon: '‚ö°' }
        ];

        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            
            statusElement.className = 'connection-status ' + status;
            
            const statusMessages = {
                'online': '‚úÖ Conectado',
                'offline': '‚ö†Ô∏è Desconectado',
                'connecting': 'üîÑ Conectando...',
                'error': '‚ùå Error'
            };
            
            statusText.textContent = statusMessages[status] || 'Desconocido';
        }

        function createNewUser() {
            return {
                totalPoints: 0,
                streak: 0,
                lastActiveDate: null,
                achievements: [],
                completedDays: [],
                totalExercises: 0,
                correctAnswers: 0,
                exercisesByType: {
                    math: 0,
                    reading: 0,
                    science: 0,
                    social: 0
                },
                dailyProgress: {}
            };
        }

        function ensureUserDataStructure(userData) {
            if (!userData) return createNewUser();
            
            // Asegurar que existan todas las propiedades
            if (!userData.exercisesByType) {
                userData.exercisesByType = {
                    math: 0,
                    reading: 0,
                    science: 0,
                    social: 0
                };
            }
            if (!userData.achievements) userData.achievements = [];
            if (!userData.completedDays) userData.completedDays = [];
            if (typeof userData.totalPoints !== 'number') userData.totalPoints = 0;
            if (typeof userData.streak !== 'number') userData.streak = 0;
            if (typeof userData.totalExercises !== 'number') userData.totalExercises = 0;
            if (typeof userData.correctAnswers !== 'number') userData.correctAnswers = 0;
            
            return userData;
        }

        // ==================== FUNCIONES DE NORMALIZACI√ìN ====================
        
        /**
         * Normaliza la estructura de datos de un usuario al formato est√°ndar
         * Maneja tanto el formato antiguo como el nuevo
         */
        function normalizeUserData(userData, username) {
            console.log(`üîß Normalizando datos para usuario: ${username}`);
            
            // Si ya tiene la estructura correcta, solo asegurar campos
            const normalized = ensureUserDataStructure(userData);
            
            // Convertir completedDays (string array) a array si es necesario
            if (normalized.completedDays && typeof normalized.completedDays === 'object' && !Array.isArray(normalized.completedDays)) {
                // Si completedDays es un objeto en lugar de array, convertirlo
                normalized.completedDays = Object.values(normalized.completedDays).filter(v => typeof v === 'string');
            }
            
            // Asegurar que completedDays sea un array
            if (!Array.isArray(normalized.completedDays)) {
                normalized.completedDays = [];
            }
            
            console.log('‚úÖ Datos normalizados para', username);
            return normalized;
        }

        /**
         * Limpia y normaliza toda la estructura de datos
         * MANTIENE usuarios en la ra√≠z como en el archivo original
         * Mueve usuarios que est√©n dentro de un objeto 'users' a la ra√≠z
         */
        function cleanAndNormalizeAllData(data) {
            console.log('üßπ Iniciando limpieza y normalizaci√≥n de datos...');
            
            const cleaned = {};
            
            // Campos del sistema que no son usuarios
            const systemFields = ['currentWeek', 'currentDay', 'currentExercise', 'stars', 
                                 'correctAnswers', 'daysCompleted', 'completedDays', 'startTime',
                                 'currentColor', 'totalFailures', 'currentExerciseFailures',
                                 'failuresByExercise', 'exerciseAttempts', 'users'];
            
            // Primero, si hay un objeto 'users', mover sus usuarios a la ra√≠z
            if (data.users && typeof data.users === 'object') {
                console.log('‚ö†Ô∏è Detectado objeto "users" - moviendo usuarios a la ra√≠z');
                Object.keys(data.users).forEach(username => {
                    console.log(`üîÑ Moviendo usuario de users.${username} a ra√≠z`);
                    cleaned[username] = normalizeUserData(data.users[username], username);
                });
            }
            
            // Procesar todos los campos en la ra√≠z
            Object.keys(data).forEach(key => {
                const value = data[key];
                
                // Si es un campo del sistema, ignorarlo (no lo necesitamos en la nueva estructura)
                if (systemFields.includes(key)) {
                    return;
                }
                
                // Si parece datos de usuario (tiene campos como totalPoints, streak, etc.)
                if (value && typeof value === 'object' && 
                    (value.totalPoints !== undefined || value.streak !== undefined || 
                     value.achievements !== undefined || value.totalExercises !== undefined ||
                     value.completedDays !== undefined)) {
                    
                    console.log(`üë§ Usuario encontrado en ra√≠z: ${key}`);
                    // Si ya lo procesamos desde 'users', no sobrescribir
                    if (!cleaned[key]) {
                        cleaned[key] = normalizeUserData(value, key);
                    }
                }
            });
            
            console.log('‚úÖ Limpieza completada. Usuarios encontrados:', Object.keys(cleaned));
            return cleaned;
        }
        
        // ==================== FIN FUNCIONES DE NORMALIZACI√ìN ====================

        async function login() {
            const username = document.getElementById('usernameInput').value.trim();
            
            if (!username) {
                alert('¬°Por favor escribe tu nombre de entrenador s√∫per genial! üòä');
                return;
            }
            
            appState.currentUser = username;
            document.getElementById('currentUserDisplay').textContent = username;
            
            updateConnectionStatus('connecting');
            await loadUserData();
            
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            updateUserInterface();
            generateWeeks();
            
            // Cargar las pesta√±as iniciales
            loadStats();
            loadAchievements();
            loadRanking();
        }

        async function loadUserData() {
            try {
                const response = await fetch(`${JSONBIN_CONFIG.apiUrl}/b/${JSONBIN_CONFIG.binId}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': JSONBIN_CONFIG.masterKey
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üì¶ Datos recibidos del servidor:', data.record);
                    
                    // ====== APLICAR LIMPIEZA Y NORMALIZACI√ìN ======
                    appState.allUsersData = cleanAndNormalizeAllData(data.record || {});
                    console.log('‚ú® Datos normalizados:', appState.allUsersData);
                    
                    if (!appState.allUsersData[appState.currentUser]) {
                        appState.allUsersData[appState.currentUser] = createNewUser();
                    }
                    
                    appState.userData = normalizeUserData(appState.allUsersData[appState.currentUser], appState.currentUser);
                    
                    // Guardar la versi√≥n limpia de vuelta al servidor
                    await saveUserData();
                    
                    updateConnectionStatus('online');
                    checkStreak();
                } else {
                    throw new Error('Error al cargar datos');
                }
            } catch (error) {
                console.error('Error:', error);
                updateConnectionStatus('error');
                
                appState.allUsersData[appState.currentUser] = createNewUser();
                appState.userData = ensureUserDataStructure(appState.allUsersData[appState.currentUser]);
            }
        }

        async function saveUserData() {
            try {
                appState.allUsersData[appState.currentUser] = appState.userData;
                
                const response = await fetch(`${JSONBIN_CONFIG.apiUrl}/b/${JSONBIN_CONFIG.binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_CONFIG.masterKey
                    },
                    body: JSON.stringify(appState.allUsersData)
                });
                
                if (response.ok) {
                    updateConnectionStatus('online');
                } else {
                    throw new Error('Error al guardar');
                }
            } catch (error) {
                console.error('Error al guardar:', error);
                updateConnectionStatus('error');
            }
        }

        function checkStreak() {
            const today = new Date().toDateString();
            const lastActive = appState.userData.lastActiveDate;
            
            if (!lastActive) {
                appState.userData.streak = 0;
                return;
            }
            
            const lastDate = new Date(lastActive);
            const diffTime = new Date(today) - lastDate;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays > 1) {
                appState.userData.streak = 0;
            }
        }

        function updateUserInterface() {
            const userData = appState.userData || createNewUser();
            
            document.getElementById('userName').textContent = appState.currentUser || 'Entrenador';
            document.getElementById('userAvatar').textContent = appState.currentUser ? appState.currentUser[0].toUpperCase() : 'üéÆ';
            document.getElementById('totalPoints').textContent = userData.totalPoints || 0;
            document.getElementById('streak').textContent = userData.streak || 0;
            document.getElementById('achievements').textContent = (userData.achievements && userData.achievements.length) || 0;
            
            const level = Math.floor(userData.totalPoints / 100) + 1;
            const levelNames = {
                1: 'Novato Genial',
                2: 'Aprendiz S√∫per',
                3: 'Estudiante Pro',
                4: 'Experto Total',
                5: 'Maestro Pokemon',
                10: '¬°CAMPE√ìN LEGENDARIO!'
            };
            const levelName = levelNames[Math.min(level, 10)] || `Nivel ${level}`;
            document.getElementById('userLevel').textContent = `Nivel ${level} - ${levelName}`;
        }

        function generateWeeks() {
            const container = document.getElementById('weeksContainer');
            container.innerHTML = '';
            
            const today = new Date();
            const weeks = 1;
            
            for (let week = 0; week < weeks; week++) {
                const weekDiv = document.createElement('div');
                weekDiv.style.marginBottom = '40px';
                
                const weekHeader = document.createElement('h3');
                weekHeader.style.fontFamily = "'Fredoka One', cursive";
                weekHeader.style.fontSize = '24px';
                weekHeader.style.marginBottom = '20px';
                weekHeader.style.color = '#2d3436';
                weekHeader.textContent = `üåü Semana ${week + 1}`;
                weekDiv.appendChild(weekHeader);
                
                const grid = document.createElement('div');
                grid.className = 'calendar-grid';
                
                const dayNames = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
                dayNames.forEach(day => {
                    const header = document.createElement('div');
                    header.className = 'day-header';
                    header.textContent = day;
                    grid.appendChild(header);
                });
                
                const startDate = new Date(today);
                startDate.setDate(today.getDate() - today.getDay() + 1 + (week * 7));
                
                const firstDayOfWeek = startDate.getDay() === 0 ? 6 : startDate.getDay() - 1;
                
                for (let i = 0; i < firstDayOfWeek; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'day-cell empty';
                    grid.appendChild(emptyCell);
                }
                
                for (let day = 0; day < 7; day++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + day);
                    
                    const dayCell = document.createElement('div');
                    dayCell.className = 'day-cell';
                    
                    const dayNumber = document.createElement('div');
                    dayNumber.className = 'day-number';
                    dayNumber.textContent = currentDate.getDate();
                    dayCell.appendChild(dayNumber);
                    
                    const dateKey = currentDate.toDateString();
                    const isCompleted = appState.userData.completedDays.includes(dateKey);
                    const isToday = dateKey === today.toDateString();
                    const isPast = currentDate < today && !isToday;
                    const isFuture = currentDate > today;
                    
                    const statusIcon = document.createElement('div');
                    statusIcon.className = 'day-status';
                    
                    if (isCompleted) {
                        dayCell.classList.add('completed');
                        statusIcon.textContent = '‚úÖ';
                    } else if (isToday) {
                        dayCell.classList.add('current');
                        statusIcon.textContent = 'üéØ';
                    } else if (isFuture) {
                        dayCell.classList.add('disabled');
                        statusIcon.textContent = 'üîí';
                    } else if (isPast) {
                        // Los d√≠as pasados NO completados est√°n disponibles para recuperar
                        dayCell.classList.add('recoverable');
                        statusIcon.textContent = 'üìù';
                    }
                    
                    dayCell.appendChild(statusIcon);
                    
                    // Permitir click en d√≠a actual O d√≠as pasados no completados
                    if ((isToday || isPast) && !isCompleted) {
                        dayCell.onclick = () => startDayExercises(dateKey);
                        dayCell.style.cursor = 'pointer';
                    }
                    
                    grid.appendChild(dayCell);
                }
                
                weekDiv.appendChild(grid);
                container.appendChild(weekDiv);
            }
        }

        function generateDailyExercises() {
            const exercises = [];
            const subjects = ['math', 'reading', 'science', 'social'];
            
            // Crear un "seed" √∫nico para el d√≠a actual basado en la fecha
            const dateKey = appState.currentDay || new Date().toDateString();
            const seed = hashString(dateKey);
            
            subjects.forEach(subject => {
                const subjectExercises = exerciseBank[subject];
                const count = subject === 'math' || subject === 'reading' ? 3 : 2;
                
                // Usar el seed para obtener una selecci√≥n determin√≠stica
                const shuffled = [...subjectExercises].sort((a, b) => {
                    const hashA = hashString(JSON.stringify(a) + seed);
                    const hashB = hashString(JSON.stringify(b) + seed);
                    return hashA - hashB;
                });
                
                for (let i = 0; i < count && i < shuffled.length; i++) {
                    exercises.push({
                        ...shuffled[i],
                        subject: subject
                    });
                }
            });
            
            // Mezclar los ejercicios de forma determin√≠stica
            return exercises.sort((a, b) => {
                const hashA = hashString(JSON.stringify(a) + seed);
                const hashB = hashString(JSON.stringify(b) + seed);
                return hashA - hashB;
            });
        }

        // Funci√≥n para crear un hash simple y determin√≠stico de una cadena
        function hashString(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convertir a entero de 32 bits
            }
            return Math.abs(hash);
        }

        function startDayExercises(dateKey) {
            appState.currentDay = dateKey;
            appState.currentExerciseIndex = 0;
            appState.currentExercises = generateDailyExercises();
            appState.sessionStartTime = Date.now();
            appState.timeRemaining = 1800;
            
            document.getElementById('exerciseModal').style.display = 'flex';
            updateProgressIndicator();
            startTimer();
            loadExercise();
        }

        function startTimer() {
            if (appState.timerInterval) {
                clearInterval(appState.timerInterval);
            }
            
            appState.timerInterval = setInterval(() => {
                appState.timeRemaining--;
                
                const minutes = Math.floor(appState.timeRemaining / 60);
                const seconds = appState.timeRemaining % 60;
                document.getElementById('timerDisplay').textContent = 
                    `‚è±Ô∏è Tiempo: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (appState.timeRemaining <= 0) {
                    clearInterval(appState.timerInterval);
                    alert('‚è∞ ¬°Se acab√≥ el tiempo! Pero no te preocupes, ¬°puedes seguir ma√±ana! üí™');
                    closeExerciseModal();
                }
            }, 1000);
        }

        function updateProgressIndicator() {
            const container = document.getElementById('progressIndicator');
            container.innerHTML = '';
            
            appState.currentExercises.forEach((_, index) => {
                const dot = document.createElement('div');
                dot.className = 'progress-dot';
                if (index < appState.currentExerciseIndex) {
                    dot.classList.add('completed');
                } else if (index === appState.currentExerciseIndex) {
                    dot.classList.add('current');
                }
                container.appendChild(dot);
            });
        }

        function loadExercise() {
            const exercise = appState.currentExercises[appState.currentExerciseIndex];
            const container = document.getElementById('exerciseContainer');
            
            document.getElementById('exerciseTitle').textContent = 
                `Ejercicio ${appState.currentExerciseIndex + 1} de ${appState.currentExercises.length}`;
            
            const badges = document.getElementById('subjectBadges');
            badges.innerHTML = `<span class="subject-badge ${exercise.subject}">${getSubjectName(exercise.subject)}</span>`;
            
            document.getElementById('hintBox').classList.remove('visible');
            document.getElementById('feedbackBox').classList.remove('visible');
            document.getElementById('explanationBox').classList.remove('visible');
            document.getElementById('checkBtn').style.display = 'inline-block';
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('hintBtn').style.display = 'inline-block';
            appState.selectedAnswer = null;
            
            container.innerHTML = '';
            
            // Instrucci√≥n
            if (exercise.instruction) {
                const instructionDiv = document.createElement('div');
                instructionDiv.className = 'instruction-box';
                instructionDiv.innerHTML = `
                    <h4>üìã Instrucciones</h4>
                    <p>${exercise.instruction}</p>
                `;
                container.appendChild(instructionDiv);
            }
            
            // Texto de lectura LARGO si existe
            if (exercise.passage) {
                const passageDiv = document.createElement('div');
                passageDiv.className = 'reading-passage';
                
                if (exercise.passageTitle) {
                    passageDiv.innerHTML = `<h4>${exercise.passageTitle}</h4>`;
                }
                
                const paragraphs = exercise.passage.split('\n\n');
                paragraphs.forEach(para => {
                    const p = document.createElement('p');
                    p.textContent = para;
                    passageDiv.appendChild(p);
                });
                
                container.appendChild(passageDiv);
            }
            
            // Pregunta
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-container';
            
            const questionText = document.createElement('div');
            questionText.className = 'question-text';
            questionText.textContent = exercise.question;
            questionDiv.appendChild(questionText);
            
            // Opciones
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'options-container';
            
            exercise.options.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = option;
                btn.onclick = () => selectOption(index);
                optionsContainer.appendChild(btn);
            });
            
            questionDiv.appendChild(optionsContainer);
            container.appendChild(questionDiv);
        }

        function getSubjectName(subject) {
            const names = {
                'math': 'üßÆ Matem√°ticas',
                'reading': 'üìñ Lengua',
                'science': 'üî¨ Ciencias Naturales',
                'social': 'üåç Ciencias Sociales'
            };
            return names[subject] || subject;
        }

        function selectOption(index) {
            document.querySelectorAll('.option-btn').forEach((btn, i) => {
                btn.classList.remove('selected');
                if (i === index) {
                    btn.classList.add('selected');
                }
            });
            appState.selectedAnswer = index;
        }

        function showHint() {
            const exercise = appState.currentExercises[appState.currentExerciseIndex];
            document.getElementById('hintText').textContent = exercise.hint;
            document.getElementById('hintBox').classList.add('visible');
        }

        function checkAnswer() {
            const exercise = appState.currentExercises[appState.currentExerciseIndex];
            
            if (appState.selectedAnswer === null) {
                alert('¬°Por favor selecciona una respuesta primero! üòä');
                return;
            }
            
            const isCorrect = appState.selectedAnswer === exercise.correct;
            
            document.querySelectorAll('.option-btn').forEach((btn, index) => {
                btn.style.pointerEvents = 'none';
                if (index === exercise.correct) {
                    btn.classList.add('correct');
                } else if (index === appState.selectedAnswer && !isCorrect) {
                    btn.classList.add('incorrect');
                }
            });
            
            appState.userData.totalExercises++;
            appState.userData.exercisesByType[exercise.subject]++;
            
            if (isCorrect) {
                appState.userData.correctAnswers++;
                appState.userData.totalPoints += 10;
                showFeedback(true, exercise);
            } else {
                showFeedback(false, exercise);
            }
            
            showExplanation(exercise);
            
            document.getElementById('checkBtn').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'inline-block';
            document.getElementById('hintBtn').style.display = 'none';
            
            updateUserInterface();
        }

        function showFeedback(isCorrect, exercise) {
            const feedbackBox = document.getElementById('feedbackBox');
            const feedbackText = document.getElementById('feedbackText');
            
            feedbackBox.className = 'feedback-box visible';
            
            if (isCorrect) {
                feedbackBox.classList.add('correct');
                const messages = [
                    'üéâ ¬°S√∫per correcto! ¬°Eres genial!',
                    '‚≠ê ¬°Perfecto! ¬°Lo has clavado!',
                    'üåü ¬°Incre√≠ble! ¬°Sigue as√≠!',
                    'üí™ ¬°Excelente trabajo, campe√≥n!',
                    'üèÜ ¬°Bravo! ¬°Eres un crack!'
                ];
                feedbackText.textContent = messages[Math.floor(Math.random() * messages.length)];
            } else {
                feedbackBox.classList.add('incorrect');
                const correctAnswerText = exercise.options[exercise.correct];
                
                feedbackText.innerHTML = `
                    ‚ùå ¬°Ups! No es correcto esta vez.<br>
                    <span style="font-size: 16px; margin-top: 10px; display: block;">
                        La respuesta correcta es: <strong>${correctAnswerText}</strong><br>
                        ¬°No te preocupes, sigue intent√°ndolo! üí™
                    </span>
                `;
            }
        }

        function showExplanation(exercise) {
            const explanationBox = document.getElementById('explanationBox');
            const explanationText = document.getElementById('explanationText');
            
            if (exercise.explanation) {
                explanationText.textContent = exercise.explanation;
                explanationBox.classList.add('visible');
            }
        }

        function nextExercise() {
            appState.currentExerciseIndex++;
            
            if (appState.currentExerciseIndex >= appState.currentExercises.length) {
                completeDayExercises();
            } else {
                updateProgressIndicator();
                loadExercise();
            }
        }

        function completeDayExercises() {
            clearInterval(appState.timerInterval);
            
            const dateKey = appState.currentDay;
            if (!appState.userData.completedDays.includes(dateKey)) {
                appState.userData.completedDays.push(dateKey);
            }
            
            const today = new Date().toDateString();
            if (!appState.userData.lastActiveDate || new Date(appState.userData.lastActiveDate).toDateString() !== today) {
                appState.userData.streak++;
                appState.userData.lastActiveDate = today;
            }
            
            const timeTaken = (Date.now() - appState.sessionStartTime) / 1000;
            
            checkAchievements(timeTaken);
            saveUserData();
            
            alert(`üéâ ¬°S√∫per bien hecho! ¬°Has completado el d√≠a!\n\n‚≠ê Puntos ganados: ${appState.userData.totalPoints}\nüî• Racha actual: ${appState.userData.streak} d√≠as`);
            
            closeExerciseModal();
            generateWeeks();
            updateUserInterface();
        }

        function checkAchievements(timeTaken) {
            const toCheck = [];
            
            if (appState.userData.completedDays.length === 1) {
                toCheck.push('first_day');
            }
            if (appState.userData.completedDays.length === 7) {
                toCheck.push('week_warrior');
            }
            if (appState.userData.streak === 5) {
                toCheck.push('streak_5');
            }
            if (appState.userData.streak === 10) {
                toCheck.push('streak_10');
            }
            if (appState.userData.exercisesByType.math >= 20) {
                toCheck.push('math_master');
            }
            if (appState.userData.exercisesByType.reading >= 20) {
                toCheck.push('reading_pro');
            }
            if (appState.userData.exercisesByType.science >= 20) {
                toCheck.push('science_genius');
            }
            if (appState.userData.exercisesByType.social >= 20) {
                toCheck.push('social_expert');
            }
            if (appState.userData.totalExercises >= 100) {
                toCheck.push('century_club');
            }
            if (timeTaken < 1200) {
                toCheck.push('speed_demon');
            }
            
            const accuracy = (appState.userData.correctAnswers / appState.userData.totalExercises) * 100;
            if (accuracy === 100 && appState.userData.totalExercises >= 10) {
                toCheck.push('perfect_score');
            }
            
            toCheck.forEach(achievementId => {
                if (!appState.userData.achievements.includes(achievementId)) {
                    unlockAchievement(achievementId);
                }
            });
        }

        function unlockAchievement(achievementId) {
            appState.userData.achievements.push(achievementId);
            const achievement = achievements.find(a => a.id === achievementId);
            
            if (achievement) {
                document.getElementById('unlockedIcon').textContent = achievement.icon;
                document.getElementById('unlockedName').textContent = achievement.name;
                document.getElementById('unlockedDescription').textContent = achievement.description;
                document.getElementById('achievementUnlock').classList.add('visible');
                
                setTimeout(() => {
                    document.getElementById('achievementUnlock').classList.remove('visible');
                }, 5000);
            }
        }

        function closeAchievementUnlock() {
            document.getElementById('achievementUnlock').classList.remove('visible');
        }

        function closeExerciseModal() {
            clearInterval(appState.timerInterval);
            document.getElementById('exerciseModal').style.display = 'none';
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            if (tabName === 'stats') {
                loadStats();
            } else if (tabName === 'achievements') {
                loadAchievements();
            } else if (tabName === 'ranking') {
                loadRanking();
            }
        }

        function loadRanking() {
            const allUsers = Object.entries(appState.allUsersData);
            
            console.log('üìä Ranking - Total usuarios:', allUsers.length);
            console.log('üìä Usuarios:', allUsers);
            
            if (allUsers.length === 0) {
                showNoRankingData();
                return;
            }
            
            let filteredUsers = allUsers;
            let showingFiltered = false;
            
            if (appState.currentRankingFilter === 'week') {
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                const weekFiltered = allUsers.filter(([_, data]) => {
                    return data.completedDays && data.completedDays.some(day => new Date(day) >= weekAgo);
                });
                // Si hay resultados con el filtro, usarlos; si no, mostrar todos
                if (weekFiltered.length > 0) {
                    filteredUsers = weekFiltered;
                    showingFiltered = true;
                }
            } else if (appState.currentRankingFilter === 'month') {
                const monthAgo = new Date();
                monthAgo.setMonth(monthAgo.getMonth() - 1);
                const monthFiltered = allUsers.filter(([_, data]) => {
                    return data.completedDays && data.completedDays.some(day => new Date(day) >= monthAgo);
                });
                // Si hay resultados con el filtro, usarlos; si no, mostrar todos
                if (monthFiltered.length > 0) {
                    filteredUsers = monthFiltered;
                    showingFiltered = true;
                }
            }
            
            console.log('üìä Usuarios filtrados:', filteredUsers.length);
            
            const sortedUsers = filteredUsers.sort((a, b) => {
                const aAchievements = a[1].achievements ? a[1].achievements.length : 0;
                const bAchievements = b[1].achievements ? b[1].achievements.length : 0;
                if (bAchievements !== aAchievements) {
                    return bAchievements - aAchievements;
                }
                return (b[1].totalPoints || 0) - (a[1].totalPoints || 0);
            });
            
            const podiumContainer = document.getElementById('podiumContainer');
            const tableContainer = document.getElementById('rankingTableContainer');
            podiumContainer.innerHTML = '';
            tableContainer.innerHTML = '';
            
            // Mostrar mensaje si estamos filtrando sin resultados del filtro
            if (!showingFiltered && appState.currentRankingFilter !== 'all') {
                const notice = document.createElement('div');
                notice.style.cssText = 'text-align: center; padding: 15px; background: #ffeaa7; border-radius: 15px; margin-bottom: 20px; border: 3px solid #fdcb6e;';
                notice.innerHTML = '<p style="font-weight: 700; color: #2d3436; margin: 0;">‚ÑπÔ∏è No hay actividad en este periodo. Mostrando todos los usuarios.</p>';
                podiumContainer.parentElement.insertBefore(notice, podiumContainer);
            }
            
            // PODIO - Mostrar top 3 (o menos si hay menos usuarios)
            const top3 = sortedUsers.slice(0, 3);
            if (top3.length > 0) {
                const podium = document.createElement('div');
                podium.className = 'podium';
                
                const positions = ['second', 'first', 'third'];
                const medals = ['ü•à', 'ü•á', 'ü•â'];
                
                // Si solo hay 1 o 2 usuarios, ajustar orden
                if (top3.length === 1) {
                    const [username, data] = top3[0];
                    const place = document.createElement('div');
                    place.className = 'podium-place first';
                    place.innerHTML = `
                        <div class="podium-rank">ü•á</div>
                        <div class="podium-name">${username}</div>
                        <div class="podium-score">‚≠ê ${data.totalPoints || 0}</div>
                        <div class="podium-score">üèÜ ${data.achievements ? data.achievements.length : 0}</div>
                    `;
                    podium.appendChild(place);
                } else if (top3.length === 2) {
                    [0, 1].forEach((index) => {
                        const [username, data] = top3[index];
                        const place = document.createElement('div');
                        place.className = `podium-place ${index === 0 ? 'first' : 'second'}`;
                        place.innerHTML = `
                            <div class="podium-rank">${medals[index]}</div>
                            <div class="podium-name">${username}</div>
                            <div class="podium-score">‚≠ê ${data.totalPoints || 0}</div>
                            <div class="podium-score">üèÜ ${data.achievements ? data.achievements.length : 0}</div>
                        `;
                        podium.appendChild(place);
                    });
                } else {
                    // 3 o m√°s usuarios - orden normal: 2do, 1ro, 3ro
                    [1, 0, 2].forEach((index, displayIndex) => {
                        if (top3[index]) {
                            const [username, data] = top3[index];
                            const place = document.createElement('div');
                            place.className = `podium-place ${positions[displayIndex]}`;
                            place.innerHTML = `
                                <div class="podium-rank">${medals[index]}</div>
                                <div class="podium-name">${username}</div>
                                <div class="podium-score">‚≠ê ${data.totalPoints || 0}</div>
                                <div class="podium-score">üèÜ ${data.achievements ? data.achievements.length : 0}</div>
                            `;
                            podium.appendChild(place);
                        }
                    });
                }
                
                podiumContainer.appendChild(podium);
            }
            
            // TABLA - Mostrar el resto (posici√≥n 4 en adelante)
            const remainingUsers = sortedUsers.slice(3);
            if (remainingUsers.length > 0) {
                remainingUsers.forEach(([username, data], index) => {
                    const row = document.createElement('div');
                    row.className = 'ranking-row';
                    if (username === appState.currentUser) {
                        row.classList.add('current-user');
                    }
                    
                    row.innerHTML = `
                        <div class="ranking-position">#${index + 4}</div>
                        <div class="ranking-user">${username}</div>
                        <div class="ranking-stats">
                            <span>‚≠ê ${data.totalPoints || 0}</span>
                            <span>üèÜ ${data.achievements ? data.achievements.length : 0}</span>
                            <span>üî• ${data.streak || 0}</span>
                        </div>
                    `;
                    
                    tableContainer.appendChild(row);
                });
            } else if (sortedUsers.length <= 3) {
                // Si hay 3 o menos usuarios, mostrar un mensaje amigable
                tableContainer.innerHTML = `
                    <div style="text-align: center; padding: 30px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 20px; border: 3px solid #74b9ff; margin-top: 20px;">
                        <div style="font-size: 60px; margin-bottom: 15px;">üéØ</div>
                        <h4 style="font-family: 'Fredoka One', cursive; font-size: 20px; color: #2d3436; margin-bottom: 10px;">¬°Top ${sortedUsers.length} de entrenadores!</h4>
                        <p style="font-size: 16px; color: #636e72; font-weight: 600;">¬°Invita a m√°s amigos para competir! üöÄ</p>
                    </div>
                `;
            }
            
            console.log('üìä Ranking cargado - Podio:', top3.length, 'Tabla:', remainingUsers.length);
        }

        function setRankingFilter(filter) {
            appState.currentRankingFilter = filter;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            loadRanking();
        }

        function showNoRankingData() {
            const podiumContainer = document.getElementById('podiumContainer');
            const tableContainer = document.getElementById('rankingTableContainer');
            
            podiumContainer.innerHTML = '';
            tableContainer.innerHTML = `
                <div style="text-align: center; padding: 50px; background: white; border-radius: 20px; border: 3px solid #74b9ff;">
                    <div style="font-size: 80px; margin-bottom: 20px;">üåü</div>
                    <h3 style="font-family: 'Fredoka One', cursive; font-size: 24px; color: #2d3436; margin-bottom: 15px;">¬°S√© el primer s√∫per entrenador!</h3>
                    <p style="font-size: 16px; color: #636e72; font-weight: 600;">Completa algunos ejercicios geniales para aparecer en el ranking de campeones.</p>
                </div>
            `;
        }

        function loadStats() {
            const content = document.getElementById('statsContent');
            const userData = appState.userData || createNewUser();
            
            console.log('üìä LoadStats - userData:', userData);
            console.log('üìä LoadStats - content element:', content);
            
            if (!content) {
                console.error('‚ùå No se encontr√≥ el elemento statsContent');
                return;
            }
            
            const accuracy = userData.totalExercises > 0 
                ? Math.round((userData.correctAnswers / userData.totalExercises) * 100)
                : 0;
            
            const allUsers = Object.entries(appState.allUsersData);
            const sortedByAchievements = allUsers.sort((a, b) => {
                const aAchievements = a[1].achievements ? a[1].achievements.length : 0;
                const bAchievements = b[1].achievements ? b[1].achievements.length : 0;
                if (bAchievements !== aAchievements) {
                    return bAchievements - aAchievements;
                }
                return (b[1].totalPoints || 0) - (a[1].totalPoints || 0);
            });
            
            const userRankPosition = sortedByAchievements.findIndex(([username]) => username === appState.currentUser) + 1;
            
            content.innerHTML = `
                <div class="stats-kids">
                    <div class="stat-card-big">
                        <div class="stat-icon-big">üéØ</div>
                        <div class="stat-number-big">${userData.totalExercises}</div>
                        <div class="stat-label-big">Ejercicios S√∫per Completados</div>
                    </div>
                    
                    <div class="stat-card-big">
                        <div class="stat-icon-big">üèÜ</div>
                        <div class="stat-number-big">${userRankPosition > 0 ? `#${userRankPosition}` : 'üåü'}</div>
                        <div class="stat-label-big">Mi Posici√≥n en el Ranking</div>
                    </div>
                    
                    <div class="stat-card-big">
                        <div class="stat-icon-big">üéñÔ∏è</div>
                        <div class="stat-number-big">${userData.achievements.length}</div>
                        <div class="stat-label-big">Logros S√∫per Geniales</div>
                    </div>
                    
                    <div class="stat-card-big">
                        <div class="stat-icon-big">üî•</div>
                        <div class="stat-number-big">${userData.streak}</div>
                        <div class="stat-label-big">D√≠as Seguidos Geniales</div>
                    </div>
                </div>
                
                <div style="margin-top: 40px; padding: 30px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 25px; border: 3px solid #74b9ff;">
                    <h3 style="font-family: 'Fredoka One', cursive; font-size: 28px; text-align: center; margin-bottom: 30px; color: #2d3436;">üìä ¬°Mis N√∫meros S√∫per Geniales!</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center; padding: 20px; background: white; border-radius: 15px; border: 3px solid #ff6b6b;">
                            <div style="font-size: 40px; margin-bottom: 10px;">üßÆ</div>
                            <div style="font-family: 'Fredoka One', cursive; font-size: 24px; color: #ff6b6b;">${userData.exercisesByType.math || 0}</div>
                            <div style="font-weight: 700; color: #636e72;">Mates Geniales</div>
                        </div>
                        
                        <div style="text-align: center; padding: 20px; background: white; border-radius: 15px; border: 3px solid #4ecdc4;">
                            <div style="font-size: 40px; margin-bottom: 10px;">üìñ</div>
                            <div style="font-family: 'Fredoka One', cursive; font-size: 24px; color: #4ecdc4;">${userData.exercisesByType.reading || 0}</div>
                            <div style="font-weight: 700; color: #636e72;">S√∫per Lectura</div>
                        </div>
                        
                        <div style="text-align: center; padding: 20px; background: white; border-radius: 15px; border: 3px solid #74b9ff;">
                            <div style="font-size: 40px; margin-bottom: 10px;">üî¨</div>
                            <div style="font-family: 'Fredoka One', cursive; font-size: 24px; color: #74b9ff;">${userData.exercisesByType.science || 0}</div>
                            <div style="font-weight: 700; color: #636e72;">Ciencias Naturales</div>
                        </div>
                        
                        <div style="text-align: center; padding: 20px; background: white; border-radius: 15px; border: 3px solid #a29bfe;">
                            <div style="font-size: 40px; margin-bottom: 10px;">üåç</div>
                            <div style="font-family: 'Fredoka One', cursive; font-size: 24px; color: #a29bfe;">${userData.exercisesByType.social || 0}</div>
                            <div style="font-weight: 700; color: #636e72;">Ciencias Sociales</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadAchievements() {
            const grid = document.getElementById('achievementGrid');
            grid.innerHTML = '';
            
            const userData = appState.userData || createNewUser();
            
            achievements.forEach(achievement => {
                const isUnlocked = userData.achievements && userData.achievements.includes(achievement.id);
                
                const card = document.createElement('div');
                card.className = `achievement-card ${isUnlocked ? 'unlocked' : ''}`;
                
                card.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <h4 style="font-family: 'Fredoka One', cursive; margin-bottom: 10px;">${achievement.name}</h4>
                    <p style="font-weight: 600; font-size: 14px;">${achievement.description}</p>
                    <div style="margin-top: 15px; font-size: 14px; font-weight: 700;">
                        ${isUnlocked ? 'üéâ ¬°DESBLOQUEADO!' : 'üîê Bloqueado'}
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        async function testConnection() {
            updateConnectionStatus('connecting');
            try {
                const response = await fetch(`${JSONBIN_CONFIG.apiUrl}/b/${JSONBIN_CONFIG.binId}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': JSONBIN_CONFIG.masterKey
                    }
                });
                
                if (response.ok) {
                    updateConnectionStatus('online');
                    alert('‚úÖ ¬°Conexi√≥n s√∫per exitosa con JSONBin.io! üéâ');
                    await loadUserData();
                } else {
                    updateConnectionStatus('error');
                    alert('‚ùå Error de conexi√≥n: ' + response.status);
                }
            } catch (error) {
                updateConnectionStatus('error');
                alert('‚ùå Error de red: ' + error.message);
            }
        }

        function resetProgress() {
            if (confirm('¬øEst√°s s√∫per seguro de que quieres empezar de nuevo? ¬°Perder√°s todos tus logros geniales! üò±')) {
                appState.userData = createNewUser();
                saveUserData();
                updateUserInterface();
                generateWeeks();
                alert('üéâ ¬°Progreso reiniciado! ¬°Nueva aventura comenzando! üöÄ');
            }
        }

        function exportData() {
            const dataToExport = {
                user: appState.currentUser,
                data: appState.userData,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `academia_pokemon_${appState.currentUser}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            alert('üì• ¬°Datos s√∫per descargados! üéâ');
        }

        async function deleteUser() {
            const confirmMessage = `‚ö†Ô∏è ATENCI√ìN ‚ö†Ô∏è\n\n¬øEst√°s COMPLETAMENTE seguro de que quieres ELIMINAR tu usuario "${appState.currentUser}"?\n\nEsta acci√≥n:\n- Borrar√° PERMANENTEMENTE todos tus datos del servidor\n- NO se puede deshacer\n- Perder√°s TODOS tus puntos, logros y progreso\n\nEscribe "${appState.currentUser}" para confirmar:`;
            
            const confirmation = prompt(confirmMessage);
            
            if (confirmation === appState.currentUser) {
                try {
                    updateConnectionStatus('connecting');
                    
                    // Eliminar el usuario de allUsersData
                    delete appState.allUsersData[appState.currentUser];
                    
                    // Guardar en el servidor
                    const response = await fetch(`${JSONBIN_CONFIG.apiUrl}/b/${JSONBIN_CONFIG.binId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': JSONBIN_CONFIG.masterKey
                        },
                        body: JSON.stringify(appState.allUsersData)
                    });
                    
                    if (response.ok) {
                        updateConnectionStatus('online');
                        alert('‚úÖ Usuario eliminado correctamente del servidor.\n\n¬°Hasta pronto! üëã');
                        
                        // Limpiar estado y volver al login
                        appState.currentUser = null;
                        appState.userData = null;
                        
                        document.getElementById('mainApp').style.display = 'none';
                        document.getElementById('loginScreen').style.display = 'flex';
                        document.getElementById('usernameInput').value = '';
                    } else {
                        throw new Error('Error al eliminar del servidor');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    updateConnectionStatus('error');
                    alert('‚ùå Error al eliminar el usuario del servidor.\n\nPor favor, int√©ntalo de nuevo.');
                }
            } else if (confirmation !== null) {
                alert('‚ùå Confirmaci√≥n incorrecta. No se ha eliminado el usuario.');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéÆ Academia Pokemon iniciada - Versi√≥n 4.0 FINAL');
            
            updateConnectionStatus('offline');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            
            document.getElementById('usernameInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });

            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    showTab(tabName);
                });
            });
        });
    </script>
</body>
</html>
