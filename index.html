<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aventuras de Aprendizaje</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Poppins:wght@400;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            font-size: 16px;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #4ade80 0%, #3b82f6 50%, #8b5cf6 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 10001;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .login-box {
            background: white;
            border-radius: 30px;
            padding: 50px 40px;
            max-width: 450px;
            width: 100%;
            box-shadow: 0 30px 90px rgba(0,0,0,0.4);
            text-align: center;
        }
        
        .login-box h2 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 15px;
        }
        
        .login-box p {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .login-box input {
            width: 100%;
            padding: 18px 20px;
            font-size: 1.2em;
            border: 3px solid #e5e7eb;
            border-radius: 15px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            transition: all 0.3s;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .login-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            padding: 18px 35px;
            font-size: 1.2em;
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            border: none;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
        }
        
        .app-container {
            background: white;
            border-radius: 40px;
            box-shadow: 0 30px 90px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
            overflow: hidden;
            display: none;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 25px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.2em;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .user-badge {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.95);
            color: #667eea;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 700;
            border: 2px solid rgba(102, 126, 234, 0.5);
            z-index: 2;
        }
        
        .config-btn {
            position: absolute;
            top: 20px;
            right: 25px;
            background: rgba(255,255,255,0.25);
            padding: 10px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            border: 2px solid rgba(255,255,255,0.3);
            z-index: 2;
        }
        
        .content {
            padding: 35px 30px;
            min-height: 500px;
            background: linear-gradient(180deg, #fafbff 0%, #f5f7ff 100%);
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.5em;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h2>üëã ¬°Hola!</h2>
            <p>Escribe tu nombre para comenzar</p>
            
            <input 
                type="text" 
                id="usernameInput" 
                placeholder="Tu nombre"
                autocomplete="off"
            >
            
            <button class="btn btn-primary" id="loginBtn" style="width: 100%; margin-bottom: 20px;">
                ‚ú® Comenzar Aventura
            </button>
            
            <button class="btn btn-secondary" id="superAdminBtn" style="width: 100%; opacity: 0.6;">
                üîê SuperAdmin
            </button>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <div class="header">
            <div class="config-btn" id="configBtn">‚öôÔ∏è Config</div>
            <div class="user-badge" id="userBadge" style="display: none;">
                üë§ <span id="currentUserName"></span>
            </div>
            <h1>üéÆ Aventuras de Aprendizaje üéÆ</h1>
        </div>
        
        <div class="content">
            <div class="loading" id="loadingScreen">
                <div>‚è≥ Cargando aventuras...</div>
            </div>
        </div>
    </div>

    <script>
        const JSONBIN_BIN_ID = '68ee144343b1c97be96704f9';
        const JSONBIN_MASTER_KEY = '$2a$10$byEkgCiPtr6uA9j.sw5Uiuld00jGPRMT1Rn9TlhHYbPe3CFfaEu6G';
        const JSONBIN_API_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;
        const SUPERADMIN_PASSWORD = 'superadmin2024';

        let currentUser = null;
        let allUsersData = {};
        let weeksData = null;
        let isSaving = false;

        let state = {
            currentWeek: 1,
            currentDay: 0,
            currentExercise: 0,
            stars: 0,
            correctAnswers: 0,
            daysCompleted: 0,
            completedDays: {},
            startTime: null,
            currentColor: '#000000',
            totalFailures: 0,
            currentExerciseFailures: 0,
            failuresByExercise: {},
            exerciseAttempts: {}
        };

        async function loadWeeksData() {
            try {
                const response = await fetch('semanas.json');
                if (!response.ok) {
                    throw new Error('No se pudo cargar semanas.json');
                }
                weeksData = await response.json();
                await checkExistingSession();
            } catch (error) {
                document.getElementById('loadingScreen').innerHTML = `
                    <div style="background: #f8d7da; color: #721c24; padding: 20px; border-radius: 15px;">
                        <h3>‚ö†Ô∏è Error al cargar las aventuras</h3>
                        <p>${error.message}</p>
                        <p>Aseg√∫rate de que el archivo <strong>semanas.json</strong> est√° en la misma carpeta.</p>
                    </div>
                `;
            }
        }

        async function checkExistingSession() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = savedUser;
                await loadAllUsersData();
                if (allUsersData[currentUser]) {
                    hideLoginScreen();
                    await initApp();
                    return;
                }
            }
            showLoginScreen();
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('usernameInput').value = '';
            setTimeout(() => {
                document.getElementById('usernameInput').focus();
            }, 100);
        }

        function hideLoginScreen() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            document.getElementById('userBadge').style.display = 'block';
            document.getElementById('currentUserName').textContent = currentUser;
        }

        async function loginUser() {
            const username = document.getElementById('usernameInput').value.trim();
            
            if (!username) {
                alert('‚ö†Ô∏è Por favor, escribe tu nombre');
                return;
            }
            
            if (username.length < 2) {
                alert('‚ö†Ô∏è El nombre debe tener al menos 2 caracteres');
                return;
            }
            
            currentUser = username;
            localStorage.setItem('currentUser', username);
            
            await loadAllUsersData();
            
            if (!allUsersData[username]) {
                console.log('Creando nuevo usuario:', username);
                allUsersData[username] = {
                    currentWeek: 1,
                    currentDay: 0,
                    currentExercise: 0,
                    stars: 0,
                    correctAnswers: 0,
                    daysCompleted: 0,
                    completedDays: {},
                    startTime: null,
                    currentColor: '#000000',
                    totalFailures: 0,
                    currentExerciseFailures: 0,
                    failuresByExercise: {},
                    exerciseAttempts: {}
                };
                await saveAllUsersData();
            }
            
            hideLoginScreen();
            await initApp();
        }

        async function loadAllUsersData() {
            try {
                const response = await fetch(JSONBIN_API_URL + '/latest', {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': JSONBIN_MASTER_KEY
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.record && typeof data.record === 'object') {
                        allUsersData = data.record;
                        console.log('‚úÖ Datos cargados desde JSONBin:', Object.keys(allUsersData).length, 'usuarios');
                    }
                } else {
                    console.log('‚ö†Ô∏è No se pudieron cargar los datos');
                    allUsersData = {};
                }
            } catch (error) {
                console.error('‚ùå Error al cargar datos:', error);
                const localBackup = localStorage.getItem('allUsersData');
                if (localBackup) {
                    allUsersData = JSON.parse(localBackup);
                    console.log('‚úÖ Datos recuperados desde backup local');
                } else {
                    allUsersData = {};
                }
            }
        }

        async function saveAllUsersData() {
            if (isSaving) return;
            
            isSaving = true;
            
            try {
                localStorage.setItem('allUsersData', JSON.stringify(allUsersData));
                
                const response = await fetch(JSONBIN_API_URL, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_MASTER_KEY
                    },
                    body: JSON.stringify(allUsersData)
                });

                if (response.ok) {
                    console.log('‚úÖ Datos guardados en JSONBin');
                } else {
                    console.error('‚ö†Ô∏è Error al guardar en JSONBin:', response.status);
                }
            } catch (error) {
                console.error('‚ùå Error al guardar datos:', error);
            } finally {
                isSaving = false;
            }
        }

        async function initApp() {
            document.getElementById('loadingScreen').innerHTML = '<div>‚úÖ ¬°Bienvenido, ' + currentUser + '!</div>';
            await loadState();
            console.log('App inicializada para usuario:', currentUser);
        }

        async function loadState() {
            if (!currentUser) return;
            
            await loadAllUsersData();
            
            if (allUsersData[currentUser]) {
                state = { ...state, ...allUsersData[currentUser] };
                console.log(`‚úÖ Estado cargado para ${currentUser}:`, state);
            } else {
                console.log(`‚ö†Ô∏è Usuario nuevo: ${currentUser}`);
                allUsersData[currentUser] = { ...state };
                await saveAllUsersData();
            }
        }

        async function saveState() {
            if (!currentUser || isSaving) return;
            
            allUsersData[currentUser] = { ...state };
            await saveAllUsersData();
        }

        function setupEventListeners() {
            const usernameInput = document.getElementById('usernameInput');
            const loginBtn = document.getElementById('loginBtn');
            const superAdminBtn = document.getElementById('superAdminBtn');
            const configBtn = document.getElementById('configBtn');
            const userBadge = document.getElementById('userBadge');
            
            if (usernameInput) {
                usernameInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        loginUser();
                    }
                });
            }
            
            if (loginBtn) {
                loginBtn.addEventListener('click', loginUser);
            }
            
            if (superAdminBtn) {
                superAdminBtn.addEventListener('click', function() {
                    const password = prompt('Contrase√±a SuperAdmin:');
                    if (password === SUPERADMIN_PASSWORD) {
                        showSuperAdmin();
                    } else if (password) {
                        alert('‚ùå Contrase√±a incorrecta');
                    }
                });
            }
            
            if (configBtn) {
                configBtn.addEventListener('click', function() {
                    alert('‚öôÔ∏è Panel de configuraci√≥n (en construcci√≥n)');
                });
            }
            
            if (userBadge) {
                userBadge.addEventListener('click', function() {
                    if (confirm('¬øQuieres cerrar sesi√≥n?')) {
                        currentUser = null;
                        localStorage.removeItem('currentUser');
                        showLoginScreen();
                    }
                });
            }
        }

        function showSuperAdmin() {
            loadAllUsersData().then(() => {
                let usersList = '';
                Object.keys(allUsersData).forEach(username => {
                    const userData = allUsersData[username];
                    usersList += `\n- ${username}: ‚≠ê${userData.stars || 0} estrellas, üìÖ${userData.daysCompleted || 0} d√≠as`;
                });
                
                const action = prompt('üëë SUPERADMIN\n\nUsuarios:' + usersList + '\n\nEscribe el nombre del usuario a eliminar, o CANCELAR:');
                
                if (action && action !== 'CANCELAR') {
                    if (allUsersData[action]) {
                        if (confirm(`¬øEliminar usuario "${action}"?`)) {
                            delete allUsersData[action];
                            saveAllUsersData();
                            alert('‚úÖ Usuario eliminado');
                        }
                    } else {
                        alert('‚ùå Usuario no encontrado');
                    }
                }
            });
        }

        window.onload = function() {
            setupEventListeners();
            loadWeeksData();
        };
    </script>
</body>
</html>
